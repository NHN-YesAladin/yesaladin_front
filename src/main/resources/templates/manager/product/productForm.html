<!doctype html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.0.0-beta5
* @link https://tabler.io
* Copyright 2018-2022 The Tabler Authors
* Copyright 2018-2022 codecalm.net Paweł Kuna
* Licensed under MIT (https://github.com/tabler/tabler/blob/master/LICENSE)
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>Yes Aladin! - Register Product</title>

  <!-- CSS files -->
  <link th:href="@{/css/tabler.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-flags.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-payments.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-vendors.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/demo.min.css}" rel="stylesheet"/>

  <!-- tui-editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</head>
<body>
<!-- Libs JS -->
<script type="text/javascript" th:src="@{/libs/apexcharts/dist/apexcharts.min.js}"></script>
<!-- Tabler Core -->
<script type="text/javascript" th:src="@{/js/tabler.min.js}"></script>
<script type="text/javascript" th:src="@{/js/demo.min.js}"></script>

<div class="wrapper">
  <!-- TODO 1 : HEADER -->
  <div th:replace="~{common/fragments/header :: fragment-header}"></div>

  <!-- TODO 2 : NAV-BAR -->
  <div th:replace="~{common/fragments/navbar :: fragment-nav-bar}"></div>

  <!-- TODO 3: BODY -->
  <div class="page-body">
    <div class="container">
      <form class="card product-form" action="/products" method="post"
            enctype="multipart/form-data">

        <div class="card-header">
          <div class="card-title">
            <h3>Yes Aladin!</h3>
            <h2>상품 등록</h2>
          </div>
        </div>

        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">상품 ISBN</label>
            <input type="text" class="form-control" id="isbn" name="isbn" placeholder="ISBN..."
                   maxlength="13" pattern="([0-9]{13})" required>
            <div class="invalid-feedback">'-'을 제외한 13자리 ISBN을 입력해주세요.</div>
          </div>

          <div class="mb-3">
            <div class="form-label">썸네일 파일</div>
            <input type="file" name="thumbnailFile" class="form-control"
                   accept="image/bmp, image/tiff, image/gif, image/jpeg, image/png" required>
            <div class="invalid-feedback">썸네일 파일을 첨부해주세요.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" id="title" name="title" placeholder="Title..."
                   minlength="1" maxlength="255" pattern="^.*(?=.*[가-힣a-z]).*$" required>
            <div class="invalid-feedback">1자 이상 255자 이하의 제목을 입력해주세요.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">목차</label>
            <textarea class="form-control" id="contents" name="contents" rows="6" minlength="1"
                      pattern="^.*(?=.*[가-힣a-z]).*$" required></textarea>
            <div class="invalid-feedback">1자 이상의 제목을 입력해주세요.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">설명</label>
            <div id="editor"></div>
            <input type="hidden" id="description" name="description">
          </div>

          <div class="mb-3">
            <div class="form-label">E-book 파일</div>
            <input type="file" name="ebookFile" class="form-control"
                   accept="application/epub+zip, application/pdf, application/vnd.comicbook+zip">
          </div>

          <div class="mb-3">
            <label class="form-label">카테고리 검색</label>
            <div class="row g-2">
              <div class="col">
                <input type="text" class="form-control" placeholder="Search for…" id="categoryName">
              </div>
              <div class="col-auto">
                <a href="#" class="btn btn-icon" aria-label="Button" id="categorySearch">
                  <!-- Download SVG icon from http://tabler-icons.io/i/search -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                </a>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <table id="searched-category-table" class="table" style="table-layout: fixed"></table>
          </div>
          <div class="mb-1">
            <label class="form-label text-success">선택한 카테고리</label>
            <table id="selected-category-view-table" class="table" style="table-layout: fixed"></table>
          </div>

          <div class="mt-1 mb-1">
            <label class="form-label text-success">선택한 저자</label>
            <div class="form-selectgroup form-selectgroup-pills">
              <label class="form-selectgroup-item">
                <input type="checkbox" name="authors" class="form-selectgroup-input" required>
                <span class="form-selectgroup-label">검색해 주세요</span>
              </label>
            </div>
          </div>


          <div class="mb-3">
            <label class="form-label">출판사 검색</label>
            <div class="row g-2">
              <div class="col">
                <input type="text" class="form-control" placeholder="Search for…" id="input-publisher-name">
              </div>
              <div class="col-auto">
                <a href="#" class="btn btn-icon" aria-label="Button" id="publisher-search">
                  <!-- Download SVG icon from http://tabler-icons.io/i/search -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                </a>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <table class="table" id="searched-publisher-table" style="table-layout: fixed"></table>
          </div>
          <div class="mb-3">
            <label class="form-label text-success">선택한 출판사</label>
            <table id="selected-publisher-table" class="table" style="table-layout: fixed"></table>
          </div>
          <div id="selected-publisher-checkbox" style="display: none"></div>

          <div class="mb-3">
            <label class="form-label">출판일</label>
            <div class="input-icon">
                <span class="input-icon-addon"><!-- Download SVG icon from http://tabler-icons.io/i/calendar -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                       viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round"><path stroke="none"
                                                                            d="M0 0h24v24H0z"
                                                                            fill="none"></path><rect
                          x="4" y="5" width="16" height="16" rx="2"></rect><line x1="16" y1="3" x2="16"
                                                                                 y2="7"></line><line
                          x1="8" y1="3" x2="8" y2="7"></line><line x1="4" y1="11" x2="20"
                                                                   y2="11"></line><line x1="11" y1="15"
                                                                                        x2="12"
                                                                                        y2="15"></line><line
                          x1="12" y1="15" x2="12" y2="18"></line></svg>
                </span>
              <input type="date" class="form-control" name="publishedDate"
                     id="datepicker-icon-prepend" value="" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">상품 유형</label>
            <select type="text" class="form-select tomselected ts-hidden-accessible"
                    name="productTypeCode" id="select-type" tabindex="-1" required>
              <option value="">-- Select Product Type --</option>
              <option th:each="type : ${productTypeResponseDtoList}" th:value="${type.getType()}" th:utext="${type.getKoName()}"></option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">태그 검색</label>
            <button type="button" class="btn btn-primary form-control mb-3" data-bs-toggle="modal" data-bs-target="#tagModal">Tag Search</button>
            <label class="form-label">선택한 태그(클릭 시 제거)</label>
            <div class="form-selectgroup form-selectgroup-pills" id="selected-main-tags-view"></div>
          </div>

          <div class="mb-3">
            <label class="form-label">정가</label>
            <input type="text" class="form-control" name="actualPrice" placeholder="Actual Price..."
                   min="1" pattern="([0-9]{1,})" required>
            <div class="invalid-feedback">정가를 숫자로 올바르게 입력해주세요.</div>
            <br/>
            <label class="form-check form-switch">
              <input class="form-check-input" name="isSeparatelyDiscount" value="false"
                     id="check-price"
                     type="checkbox"
                     onclick="changeDisplay('discount-info'); changeValue('check-price');">
              <span class="form-check-label">개별 할인 적용</span>
            </label>
            <div id="discount-info" style="display: none;">
              <div class="mb-3">
                <label class="form-label">할인율</label>
                <input type="text" class="form-control" id="discountRate" name="discountRate"
                       placeholder="Discount Rate..." value="0">
              </div>
            </div>
            <label class="form-check form-switch">
              <input class="form-check-input" name="isGivenPoint" value="false" id="check-point"
                     type="checkbox"
                     onclick="changeDisplay('point-info'); changeValue('check-point');">
              <span class="form-check-label">포인트 적립 적용</span>
            </label>
            <div id="point-info" style="display: none;">
              <div class="mb-3">
                <label class="form-label">포인트 적립율</label>
                <input type="text" class="form-control" id="givenPointRate" name="givenPointRate"
                       placeholder="Given Point Rate..." value="0">
              </div>
              <div class="mb-3">
                <div class="form-label">포인트 적립 방식</div>
                <div>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="productSavingMethodCode"
                           value="ACTUAL_PURCHASE_PRICE" checked>
                    <span class="form-check-label">실구매가</span>
                  </label>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="productSavingMethodCode"
                           value="SELLING_PRICE">
                    <span class="form-check-label">판매가</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" name="isSubscriptionAvailable" value="false"
                     id="check-subscribe"
                     type="checkbox"
                     onclick="changeDisplay('subscribe-info'); changeValue('check-subscribe');">
              <span class="form-check-label">구독 적용</span>
            </label>
            <div id="subscribe-info" style="display: none;">
              <div class="mb-3">
                <label class="form-label">구독 상품 ISSN</label>
                <input type="text" class="form-control" id='issn' name="issn" placeholder="ISSN..."
                       maxlength="8">
                <div class="invalid-feedback">'-'을 제외한 8자리 ISSN을 입력해주세요.</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">수량</label>
            <input type="text" class="form-control" id="quantity" name="quantity"
                   placeholder="Quantity..." pattern="([0-9]{1,})" required>
            <div class="invalid-feedback">수량을 입력해주세요.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">노출 우선 순위</label>
            <input type="text" class="form-control" id="preferentialShowRanking"
                   name="preferentialShowRanking"
                   placeholder="Show Ranking..." required>
            <div class="invalid-feedback">노출 우선 순위를 입력해주세요.</div>
          </div>

          <div class="mb-3">
            <div class="form-label">상품 판매 여부</div>
            <label class="form-check form-switch">
              <input class="form-check-input" name="isSale" id="check-sale" type="checkbox" checked
                     value="true" onclick="changeValue('check-sale')">
              <span class="form-check-label">상품을 판매합니다.</span>
            </label>
          </div>
        </div>
        <div class="card-footer text-end">
          <div class="d-flex">
            <a th:href="@{/manager/products}" class="btn btn-link">취소</a>
            <button type="submit" class="btn btn-primary ms-auto">등록</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- The Tag Modal -->
  <div class="modal fade" id="tagModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">태그 검색</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col">
              <input type="text" class="form-control" placeholder="Search for…" id="tag-input">
            </div>
            <div class="col-auto">
              <a href="#" class="btn btn-icon" aria-label="Button" id="tag-search">
                <!-- Download SVG icon from http://tabler-icons.io/i/search -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
              </a>
            </div>
          </div>
          <table class="table" id="searched-tag-table"></table>
          <ul id = 'tag-page' class="pagination"></ul>
        </div>
        <div class="modal-body">
          <h3><span class="label label-default">선택한 태그(클릭 시 제거)</span></h3>
          <div class="mb-3">
            <div class="form-selectgroup form-selectgroup-pills" id="selected-modal-tags-view"></div>
          </div>
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" id="save-tag-button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- The Tag Modal -->
  <div class="modal fade" id="authorModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">태그 검색</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col">
              <input type="text" class="form-control" placeholder="Search for…" id="author-input">
            </div>
            <div class="col-auto">
              <a href="#" class="btn btn-icon" aria-label="Button" id="author-search">
                <!-- Download SVG icon from http://tabler-icons.io/i/search -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
              </a>
            </div>
          </div>
          <table class="table" id="searched-author-table"></table>
        </div>
        <div class="modal-body">
          <h3><span class="label label-default">선택한 저자(클릭 시 제거)</span></h3>
          <div class="mb-3">
            <div class="form-selectgroup form-selectgroup-pills" id="selected-modal-tags"></div>
          </div>
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TODO 4 : footer -->
</div>
<div th:replace="~{common/fragments/footer :: fragment-footer}"></div>
<div class="d-none" id="front-server-url"
     th:text="${@environment.getProperty('yesaladin.front.url')}"></div>
<script>
  function changeDisplay(target) {
    let element = document.getElementById(target);
    if (element.style.display === 'none') {
      element.style.display = 'block';
    } else {
      element.style.display = 'none';
    }

  }

  function changeValue(target) {
    let element = document.getElementById(target);
    if (element.getAttribute('value') === 'false') {
      element.setAttribute('value', 'true');
    } else {
      element.setAttribute('value', 'false')
    }
    console.log('res: ' + element.getAttribute('value'));
  }
</script>

<script>
  const Editor = toastui.Editor;

  const editor = new Editor({
    el: document.querySelector('#editor'),
    previewStyle: 'vertical',
    height: '500px'
  });

  editor.addHook('addImageBlobHook', (blob, callback) => {
    const formData = new FormData();
    formData.append("data", blob);

    if (blob.size > 12582912) {
      return window.alert("File size : " + blob.size + " => 이미지 파일 최대 용량 초과");
    }

    console.log(location.origin.toString());
    fetch(location.origin.toString() + "/files/file-upload/product/description",
            {
              method: 'POST',
              body: formData
            })
            .then(res => res.json())
            .then(data => callback(data.url,
                    document.getElementById('toastuiAltTextInput').getAttribute('value')))
            .catch(err => {
              window.alert(err);
            });
  });

  window.addEventListener('load', () => {
    const productForm = document.getElementsByClassName('product-form');

    let emptyRegex = /\s/g;
    let isbnRegex = /^.*(?=.*\d)(?=^.{13}).*$/;
    let rateRegex = /^[0-9]{1}$|^[1-9]{1}[0-9]{1}$|^100$/;
    let issnRegex = /^.*(?=.*\d)(?=^.{8}).*$/;
    let quantityRegex = /^.*(?=.*\d)(?=^.{0,}).*$/;
    let preferentialShowRankingRegex = /^(0|[-]?[1-9]\d*)$/;

    Array.prototype.filter.call(productForm, (productForm) => {
      productForm.addEventListener('submit', function (event) {
        if (productForm.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }

        let isbnVal = document.getElementById('isbn').value;
        if (!isbnRegex.test(isbnVal) || emptyRegex.test(isbnVal)) {
          alert('ISBN을 - 없이 13자 입력해주세요.');
          event.preventDefault();
          return false;
        }

        document.querySelector('#description').setAttribute('value', editor.getHTML());
        if (editor.getHTML() === '<p><br></p>') {
          alert('설명을 입력해주세요');
          event.preventDefault();
          return false;
        }

        if (document.getElementById('check-price').value === 'true') {
          let discountRateVal = document.getElementById('discountRate').value;
          if (!rateRegex.test(discountRateVal) || emptyRegex.test(discountRateVal)) {
            alert('할인율을 0부터 100사이로 입력해주세요.');
            event.preventDefault();
            return false;
          }
        }

        if (document.getElementById('check-point').value === 'true') {
          let givenPointRateVal = document.getElementById('givenPointRate').value;
          if (!rateRegex.test(givenPointRateVal) || emptyRegex.test(givenPointRateVal)) {
            alert('포인트 적립율을 0부터 100사이로 입력해주세요.');
            event.preventDefault();
            return false;
          }
        }
        if (document.getElementById('check-subscribe').value === 'true') {
          let issnVal = document.getElementById('issn').value;
          if (!issnRegex.test(issnVal) || emptyRegex.test(issnVal)) {
            alert('ISSN을 - 없이 8자 입력해주세요.');
            event.preventDefault();
            return false;
          }
        }

        let quantityVal = document.getElementById('quantity').value;
        if (!quantityRegex.test(quantityVal) || emptyRegex.test(quantityVal) || quantityVal == 0) {
          alert('올바른 수량을 입력해주세요.(1 이상의 숫자)');
          event.preventDefault();
          return false;
        }

        let preferentialShowRankingVal = document.getElementById('preferentialShowRanking').value;
        if (!preferentialShowRankingRegex.test(preferentialShowRankingVal) || emptyRegex.test(
                preferentialShowRankingVal)) {
          alert('노출 우선순위를 입력해주세요. (음수 가능, 낮을수록 조회 상단에 위치하게 됩니다.)');
          event.preventDefault();
          return false;
        }

      }, false);

    });
  }, false);
  </script>


<script>
  document.getElementById('tag-search').addEventListener('click', function (e) {
    e.preventDefault();
    searchTag()
  })

  function searchTag(offset, size) {
    const input = document.getElementById('tag-input')
    const searchedTable = document.getElementById('searched-tag-table')
    const url = '/api/tags/search'

    if(input.value == null) {
      alert('검색할 단어를 입력해주세요')
      return
    }

    fetch(url + '?' + 'name=' + input.value + '&offset=' +offset  + '&size=' + size, {
      method: 'GET'
    }).then((res) => res.json())
    .then(function (data) {
      initSearchTable(searchedTable)

      const head = searchedTable.createTHead()

      const headRow = head.insertRow()
      headRow.colSpan = 3

      const headCell = headRow.insertCell()
      headCell.innerText = input.value + ' 검색 결과'

      const body = searchedTable.createTBody()

      data.searchedTagDtoList.forEach(function (dto) {
        const bodyRow = body.insertRow();
        const nameCell = bodyRow.insertCell()
        nameCell.className += 'text-center'
        nameCell.innerText = dto.name


        const selectButton = document.createElement('button')
        selectButton.setAttribute('type', 'button')
        selectButton.innerText = 'SELECT'
        selectButton.className = 'btn btn-outline-primary'
        selectButton.addEventListener('click', function (){selectTags(dto)})

        const buttonCell = bodyRow.insertCell();
        buttonCell.className += 'text-center'
        buttonCell.appendChild(selectButton)
        })
    })
  }

  function selectTags(selected) {
    const modalTagView = document.getElementById('selected-modal-tags-view')
    const mainTagsView = document.getElementById('selected-main-tags-view')
    const tags = document.getElementsByName('modal-tags')

    if(checkValue(tags, selected.id)) {
      alert('중복 태그입니다.')
      return
    }
    const modal = document.createElement('label')
    modal.className += 'form-selectgroup-item'
    modal.innerHTML = '<input type="checkbox" name="modal-tags" value=' + selected.id + ' class="form-selectgroup-input" readonly checked>'
        + '<span class = "form-selectgroup-label">'+ selected.name + '</span>'

    const main = document.createElement('label')
    main.className += 'form-selectgroup-item'
    main.innerHTML = '<input type="checkbox" name="tags" value=' + selected.id + ' class="form-selectgroup-input" readonly checked>'
        + '<span class = "form-selectgroup-label">'+ selected.name + '</span>'

    modalView.appendChild(modal)
    mainView.appendChild(main)

    modal.addEventListener('click', function () {
      modal.remove()
      main.remove()
    })

    main.addEventListener('click', function () {
      modal.remove()
      main.remove()
    })
  }
</script>

<script>
  document.getElementById('author-search').addEventListener('click', (e) =>
  e.preventDefault())

  function searchAuthor(inputId) {
    const input = document.getElementById(inputId)
    const searchedTable = document.getElementById('searched-author-table')
    const url = '/api/authors/search'

    if(input.value == null) {
      alert('검색할 단어를 입력해주세요')
      return
    }
    fetch(url + '?name=' + input.value + '&offset=0&size=5', {
      method: 'GET'
    })
    .then((res) => res.json())
    .then(function (data) {

    })
  }

  function selectCategories(selected) {

  }

  function selectAuthor(selected) {

  }

  function selectPublisher(selected) {

  }
</script>

<script>
  //검색 테이블 초기화
  function initSearchTable(table) {
    const total =  table.rows.length
    for (let i = 0; i < total; i++) {
      table.deleteRow(0)
    }
  }

  // 중복 확인
  function checkValue(checkbox, id) {
    for (let i = 0; i < checkbox.length; i++) {
      if (checkbox[i].value == id) {
        return true;
      }
    }
    return false;
  }

  function paging(page, count, currentPage, size) {
    if(currentPage > 0) {
      const pre = document.createElement('li')
      pre.className += 'page-item'
      pre.innerText = 'Previous'
      pre.addEventListener('click', function () {
        searchTag(currentPage - 1, size)
      })
      page.appendChild(pre)
    }

    const now = document.createElement('li')
    now.className += 'page-item active'
    now.innerText = 'Now'
    page.appendChild(now)

    if(count / size > currentPage) {
      const next
    }
  }
</script>
</body>
</html>