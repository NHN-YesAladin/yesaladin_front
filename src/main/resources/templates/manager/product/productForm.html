<!doctype html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.0.0-beta5
* @link https://tabler.io
* Copyright 2018-2022 The Tabler Authors
* Copyright 2018-2022 codecalm.net Paweł Kuna
* Licensed under MIT (https://github.com/tabler/tabler/blob/master/LICENSE)
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>Yes Aladin! - Register Product</title>

  <!-- CSS files -->
  <link th:href="@{/css/tabler.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-flags.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-payments.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-vendors.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/demo.min.css}" rel="stylesheet"/>

  <!-- tui-editor -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</head>
<body>
<!-- Libs JS -->
<script type="text/javascript" th:src="@{/libs/apexcharts/dist/apexcharts.min.js}"></script>
<!-- Tabler Core -->
<script type="text/javascript" th:src="@{/js/tabler.min.js}"></script>
<script type="text/javascript" th:src="@{/js/demo.min.js}"></script>

<div class="wrapper">
  <!-- TODO 1 : HEADER -->
  <div th:replace="~{common/fragments/header :: fragment-header}"></div>

  <!-- TODO 2 : NAV-BAR -->
  <div th:replace="~{common/fragments/navbar :: fragment-nav-bar}"></div>

  <!-- TODO 3: BODY -->
  <div class="page-body">
    <div class="container">
      <form class="card product-form" action="/products" method="post" enctype="multipart/form-data">

        <div class="card-header">
          <div class="card-title">
            <h3>Yes Aladin!</h3>
            <h2>상품 등록</h2>
          </div>
        </div>

        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">상품 ISBN</label>
            <input type="text" class="form-control" id="isbn" name="isbn" placeholder="ISBN..." maxlength="13" pattern="([0-9]{13})" required>
            <div class="invalid-feedback">'-'을 제외한 13자리 ISBN을 입력해주세요.</div>
          </div>

          <div class="mb-3">
            <div class="form-label">썸네일 파일</div>
            <input type="file" name="thumbnailFile" class="form-control" accept="image/bmp, image/tiff, image/gif, image/jpeg, image/png" required>
            <div class="invalid-feedback">썸네일 파일을 첨부해주세요.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" id="title" name="title" placeholder="Title..." minlength="1" maxlength="255" pattern="^.*(?=.*[가-힣a-z]).*$" required>
            <div class="invalid-feedback">1자 이상 255자 이하의 제목을 입력해주세요.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">목차</label>
            <textarea class="form-control" id="contents" name="contents" rows="6" minlength="1" pattern="^.*(?=.*[가-힣a-z]).*$" required></textarea>
            <div class="invalid-feedback">1자 이상의 제목을 입력해주세요.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">설명</label>
            <div id="editor"></div>
            <input type="hidden" id="description" name="description">
          </div>

          <div class="mb-3">
            <div class="form-label">E-book 파일</div>
            <input type="file" name="ebookFile" class="form-control"
                   accept="application/epub+zip, application/pdf, application/vnd.comicbook+zip">
          </div>

          <!--             TODO: 저자, 출판사 선홍님 검색으로 교체 예정 -->
          <!--                        <div class="mb-3"> -->
          <!--              <label class="form-label">저자</label>-->
          <!--              <div class="input-icon">-->
          <!--                <input type="text" value="" class="form-control form-control-rounded" placeholder="Search Author...">-->
          <!--                <span class="input-icon-addon">-->
          <!--                  &lt;!&ndash; Download SVG icon from http://tabler-icons.io/i/search &ndash;&gt;-->
          <!--                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>-->
          <!--                </span>-->
          <!--              </div>-->
          <!--            </div>-->
          <!--            <div class="mb-3">-->
          <!--              <label class="form-label">출판사</label>-->
          <!--              <div class="input-icon">-->
          <!--                <input type="text" value="" class="form-control form-control-rounded" placeholder="Search Publisher...">-->
          <!--                <span class="input-icon-addon">-->
          <!--                  &lt;!&ndash; Download SVG icon from http://tabler-icons.io/i/search &ndash;&gt;-->
          <!--                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>-->
          <!--                </span>-->
          <!--              </div>-->
          <!--            </div>-->
          <!-- 테스트용 저자, 출판사 -->
          <div class="mb-3">
            <label class="form-label">저자</label><!-- 다중 선택 가능하도록! -->
            <select type="text" class="form-select tomselected ts-hidden-accessible"
                    multiple="multiple" name="authors" id="select-authors" value="" tabindex="-1" required>
              <option value="" disabled>-- Select Authors --</option>
              <option th:each="author : ${authors}" th:value="${author.getId()}" th:utext="${author.getName()}"/>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">출판사</label>
            <select type="text" class="form-select tomselected ts-hidden-accessible"
                    name="publisher" id="select-publishers" value="" tabindex="-1" required>
              <option value="" disabled>-- Select Publisher --</option>
              <option th:each="publisher : ${publishers}" th:value="${publisher.getId()}" th:utext="${publisher.getName()}"/>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">출판일</label>
            <div class="input-icon">
                <span class="input-icon-addon"><!-- Download SVG icon from http://tabler-icons.io/i/calendar -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                       viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round"><path stroke="none"
                                                                            d="M0 0h24v24H0z"
                                                                            fill="none"></path><rect
                      x="4" y="5" width="16" height="16" rx="2"></rect><line x1="16" y1="3" x2="16"
                                                                             y2="7"></line><line
                      x1="8" y1="3" x2="8" y2="7"></line><line x1="4" y1="11" x2="20"
                                                               y2="11"></line><line x1="11" y1="15"
                                                                                    x2="12"
                                                                                    y2="15"></line><line
                      x1="12" y1="15" x2="12" y2="18"></line></svg>
                </span>
              <input type="date" class="form-control" name="publishedDate" id="datepicker-icon-prepend" value="" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">상품 유형</label>
            <select type="text" class="form-select tomselected ts-hidden-accessible"
                    name="productTypeCode" id="select-type" tabindex="-1" required>
              <option value="">-- Select Product Type --</option>
              <option th:each="type : ${types}" th:value="${type.getType()}"
                      th:utext="${type.getType()}"/>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">상품 태그</label>
            <select type="text" class="form-select tomselected ts-hidden-accessible" name="tags"
                    id="select-tags" multiple="multiple" value="" tabindex="-1">
              <option value="">-- Select Tags --</option>
              <option th:each="tag : ${tags}" th:value="${tag.getId()}"
                      th:utext="${tag.getName()}"/>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">정가</label>
            <input type="text" class="form-control" name="actualPrice" placeholder="Actual Price..." min="1" pattern="([0-9]{1,})" required>
            <div class="invalid-feedback">정가를 숫자로 올바르게 입력해주세요.</div>
            <br/>
            <label class="form-check form-switch">
              <input class="form-check-input" name="isSeparatelyDiscount" value="false" id="check-price"
                     type="checkbox" onclick="changeDisplay('discount-info'); changeValue('check-price');">
              <span class="form-check-label">개별 할인 적용</span>
            </label>
            <div id="discount-info" style="display: none;">
              <div class="mb-3">
                <label class="form-label">할인율</label>
                <input type="text" class="form-control" id="discountRate" name="discountRate"
                       placeholder="Discount Rate..." value="0">
              </div>
            </div>
            <label class="form-check form-switch">
              <input class="form-check-input" name="isGivenPoint" value="false" id="check-point" type="checkbox"
                     onclick="changeDisplay('point-info'); changeValue('check-point');" >
              <span class="form-check-label">포인트 적립 적용</span>
            </label>
            <div id="point-info" style="display: none;">
              <div class="mb-3">
                <label class="form-label">포인트 적립율</label>
                <input type="text" class="form-control" id="givenPointRate" name="givenPointRate"
                       placeholder="Given Point Rate..." value="0">
              </div>
              <div class="mb-3">
                <div class="form-label">포인트 적립 방식</div>
                <div>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="productSavingMethodCode"
                           value="ACTUAL_PURCHASE_PRICE" checked>
                    <span class="form-check-label">실구매가</span>
                  </label>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="productSavingMethodCode"
                           value="SELLING_PRICE">
                    <span class="form-check-label">판매가</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" name="isSubscriptionAvailable" value="false" id="check-subscribe"
                     type="checkbox" onclick="changeDisplay('subscribe-info'); changeValue('check-subscribe');">
              <span class="form-check-label">구독 적용</span>
            </label>
            <div id="subscribe-info" style="display: none;">
              <div class="mb-3">
                <label class="form-label">구독 상품 ISSN</label>
                <input type="text" class="form-control" id='issn' name="issn" placeholder="ISSN..." maxlength="8">
                <div class="invalid-feedback">'-'을 제외한 8자리 ISSN을 입력해주세요.</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">수량</label>
            <input type="text" class="form-control" id="quantity" name="quantity" placeholder="Quantity..." pattern="([0-9]{1,})" required>
            <div class="invalid-feedback">수량을 입력해주세요.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">노출 우선 순위</label>
            <input type="text" class="form-control" id="preferentialShowRanking" name="preferentialShowRanking"
                   placeholder="Show Ranking..." required>
            <div class="invalid-feedback">노출 우선 순위를 입력해주세요.</div>
          </div>

          <div class="mb-3">
            <div class="form-label">상품 판매 여부</div>
            <label class="form-check form-switch">
              <input class="form-check-input" name="isSale" id="check-sale" type="checkbox" checked
                     value="true" onclick="changeValue('check-sale')">
              <span class="form-check-label">상품을 판매합니다.</span>
            </label>
          </div>
        </div>
        <div class="card-footer text-end">
          <div class="d-flex">
            <a th:href="@{/manager/products}" class="btn btn-link">취소</a>
            <button type="submit" class="btn btn-primary ms-auto">등록</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- TODO 4 : footer -->
</div>
<div th:replace="~{common/fragments/footer :: fragment-footer}"></div>

<script>
  function changeDisplay(target) {
    let element = document.getElementById(target);
    if (element.style.display === 'none') {
      element.style.display = 'block';
    } else {
      element.style.display = 'none';
    }

  }
  function changeValue(target) {
    let element = document.getElementById(target);
    if (element.getAttribute('value') === 'false') {
      element.setAttribute('value', 'true');
    } else {
      element.setAttribute('value', 'false')
    }
    console.log('res: ' + element.getAttribute('value'));
  }
</script>

<script>
  const Editor = toastui.Editor;

  const editor = new Editor({
    el: document.querySelector('#editor'),
    previewStyle: 'vertical',
    height: '500px'
  });

  editor.addHook('addImageBlobHook', (blob, callback) => {
    const formData = new FormData();
    formData.append("data", blob);

    if (blob.size > 12582912) {
      return window.alert("File size : " + blob.size + " => 이미지 파일 최대 용량 초과");
    }

    console.log(location.origin.toString());
    fetch(location.origin.toString() + "/files/file-upload/product/description",
        {
          method: 'POST',
          body: formData
        })
    .then(res => res.json())
    .then(data => callback(data.url,
        document.getElementById('toastuiAltTextInput').getAttribute('value')))
    .catch(err => {
      window.alert(err);
    });
  });

  window.addEventListener('load', () => {
    const productForm = document.getElementsByClassName('product-form');

    let emptyRegex = /\s/g;
    let isbnRegex = /^.*(?=.*\d)(?=^.{13}).*$/;
    let rateRegex = /^[1-9]{1}$|^[1-9]{1}[0-9]{1}$|^100$/;
    let issnRegex = /^.*(?=.*\d)(?=^.{8}).*$/;
    let quantityRegex = /^.*(?=.*\d)(?=^.{0,}).*$/;
    let preferentialShowRankingRegex = /^(0|[-]?[1-9]\d*)$/;


    Array.prototype.filter.call(productForm, (productForm) => {
      productForm.addEventListener('submit', function (event) {
        if (productForm.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }

        let isbnVal = document.getElementById('isbn').value;
        if (!isbnRegex.test(isbnVal) || emptyRegex.test(isbnVal)) {
          alert('ISBN을 - 없이 13자 입력해주세요.');
          event.preventDefault();
          return false;
        }

        document.querySelector('#description').setAttribute('value', editor.getHTML());
        if (editor.getHTML() === '<p><br></p>') {
          alert('설명을 입력해주세요');
          event.preventDefault();
          return false;
        }

        if (document.getElementById('check-price').value === 'true') {
          let discountRateVal = document.getElementById('discountRate').value;
          if (!rateRegex.test(discountRateVal) || emptyRegex.test(discountRateVal)) {
            alert('할인율을 0부터 100사이로 입력해주세요.');
            event.preventDefault();
            return false;
          }
        }

        if (document.getElementById('check-point').value === 'true') {
          let givenPointRateVal = document.getElementById('givenPointRate').value;
          if (!rateRegex.test(givenPointRateVal) || emptyRegex.test(givenPointRateVal)) {
            alert('포인트 적립율을 0부터 100사이로 입력해주세요.');
            event.preventDefault();
            return false;
          }
        }
        if (document.getElementById('check-subscribe').value === 'true') {
          let issnVal = document.getElementById('issn').value;
          if (!issnRegex.test(issnVal) || emptyRegex.test(issnVal)) {
            alert('ISSN을 - 없이 8자 입력해주세요.');
            event.preventDefault();
            return false;
          }
        }

        let quantityVal = document.getElementById('quantity').value;
        if (!quantityRegex.test(quantityVal) || emptyRegex.test(quantityVal)) {
          alert('수량을 입력해주세요.');
          event.preventDefault();
          return false;
        }

        let preferentialShowRankingVal = document.getElementById('preferentialShowRanking').value;
        if (!preferentialShowRankingRegex.test(preferentialShowRankingVal) || emptyRegex.test(preferentialShowRankingVal)) {
          alert('노출 우선순위를 입력해주세요. (음수 가능, 낮을수록 조회 상단에 위치하게 됩니다.)');
          event.preventDefault();
          return false;
        }

      }, false);

    });
  }, false);
</script>
</body>
</html>
