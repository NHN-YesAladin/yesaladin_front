<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!--
    1. Download SVG icon : http://tabler-icons.io/i/home
    2. Navigation Bar 틀
        HOME : 기본 버튼
        PRODUCT : 토글 기능이 추가된 버튼(1 depth 와 2 depth 를 나누는 방법은 자유롭게)
-->
<!-- TODO 0 : 관리자용 또는 사용자용으로 카테고리 항목 구분하기 -->
<body th:fragment="fragment-nav-bar">
<div class="navbar-expand-md">
    <div class="collapse navbar-collapse" id="navbar-menu" th:data-url="${@environment.getProperty('yesaladin.gateway')}">
        <div class="navbar navbar-light">
            <div class="container-xl">
                <ul id="header-list" class="navbar-nav">
                    <!-- TODO 1 : HOME  -->
                    <li class="nav-item active">
                        <a class="nav-link"
                           href="./index.html">
                            <span class="nav-link-icon d-md-none d-lg-inline-block">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                     viewBox="0 0 24 24"
                                     stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                                     stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <polyline points="5 12 3 12 12 3 21 12 19 12"/>
                                    <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"/>
                                    <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"/>
                                </svg>
                            </span>
                            <span class="nav-link-title">Home</span>
                        </a>
                    </li>
                    <!-- TODO 2 : Product  -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" data-bs-auto-close="outside" role="button"
                           aria-expanded="false" data-bs-toggle="dropdown"
                           href="#navbar-base">
                            <span class="nav-link-title">국내도서</span>
                        </a>
                        <div class="dropdown-menu">
                            <div class="dropdown-menu-columns">
                                <!-- TODO 2-2 : 카테고리 1 DEPTH* <a> 로 1Depth 카테고리 작성-->
                                <div class="dropdown-menu-column">
                                    <a class="dropdown-item" href="./empty.html">
                                        Empty page
                                    </a>
                                </div>
                                <div class="dropdown-menu-column">
                                    <!-- TODO 2-3 : 카테고리 2 DEPTH
                                        * js로 doc 건드려서 데이터 동적 추가 바람-->
                                    <a class="dropdown-item" href="./navigation.html">
                                        Navigation
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" data-bs-auto-close="outside" role="button"
                           aria-expanded="false" data-bs-toggle="dropdown"
                           href="#navbar-base">
                            <span class="nav-link-title">국외도서</span>
                        </a>
                        <div class="dropdown-menu">
                            <div class="dropdown-menu-columns">
                                <!-- TODO 2-2 : 카테고리 1 DEPTH* <a> 로 1Depth 카테고리 작성-->
                                <div class="dropdown-menu-column">
                                    <a class="dropdown-item" href="./empty.html">
                                        Empty page
                                    </a>
                                </div>
                                <div class="dropdown-menu-column">
                                    <!-- TODO 2-3 : 카테고리 2 DEPTH
                                        * js로 doc 건드려서 데이터 동적 추가 바람-->
                                    <a class="dropdown-item" href="./navigation.html">
                                        Navigation
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
                <!-- TODO 3 : 검색 도구 (옵션) -->
                <div class="my-2 my-md-0 flex-grow-1 flex-md-grow-0 order-first order-md-last">
                    <form action="." method="get">
                        <div class="input-icon">
                            <span class="input-icon-addon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                                     stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                                     stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <circle cx="10" cy="10" r="7"/>
                                    <line x1="21" y1="21" x2="15" y2="15"/>
                                </svg>
                            </span>
                            <input type="text" class="form-control" placeholder="Search…" aria-label="Search in website">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    /*.dropdown:hover .dropdown-menu {*/
    /*    display: block;*/
    /*    margin-top: 50px;*/
    /*}*/

</style>
<script>
    let dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'))
    let dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl)
    })


    const navBar = document.getElementById("navbar-menu");
    const serverCategoryUrl = `${navBar.getAttribute("data-url")}/v1/categories`;
    window.onload = function () {
        const headerList = document.getElementById("header-list");
        fetch(serverCategoryUrl+"/parents", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        }).then((resp) => resp.json())
        .then((data) => {
            console.log(data);
            console.log(data[0].name)
            for (let i = 0; i < data.length; i++) {
                const id = data[i].id;
                const name = data[i].name;

                const list = document.createElement("li");
                const button = document.createElement("a");
                const buttonName = document.createElement("span");

                buttonName.classList.add("nav-link-title");
                buttonName.setAttribute("value", id);
                // buttonName.setAttribute("textContent", name);
                buttonName.textContent = name;


                button.classList.add("nav-link");
                button.classList.add("dropdown-toggle");
                button.setAttribute("data-bs-auto-close", "outside");
                button.setAttribute("role", "button");
                button.setAttribute("aria-expanded", "false");
                button.href = `#navbar-base`;
                button.appendChild(buttonName);


                const menu = document.createElement("div");
                const menuColumns = document.createElement("div");

                menuColumns.classList.add("dropdown-menu-columns");
                menu.classList.add("dropdown-menu");

                fetch(`${parentCategoriesUrl}/${id}/children`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    }
                }).then((resp) => resp.json())
                .then((data) => {
                    console.log(data);

                    let size = 5;
                    let term = Math.floor(data.length / size) + 1;
                    for (let i = 0; i < term; i++) {
                        let start = size * i;
                        let last = Math.min(start + size, data.length);
                        console.log(start + "  " + last);
                        const menuColumn = document.createElement("div");
                        menuColumn.classList.add("dropdown-menu-column");

                        for (let j = start; j < last; j++) {
                            const innerButton = document.createElement("a");
                            innerButton.classList.add("dropdown-item");
                            //TODO 카테고리 별 조회 리스트 페이지로 넘겨야함
                            innerButton.href = "#"; //"상품페이지url/{categoryId}"
                            innerButton.text = data[j].name;

                            menuColumn.appendChild(innerButton);
                        }
                        menuColumns.appendChild(menuColumn);
                        menu.appendChild(menuColumns);
                    }

                });

                list.classList.add("nav-item");
                list.classList.add("dropdown");
                list.appendChild(button);
                list.appendChild(menu);


                headerList.appendChild(list);
                window.location.href = "#";

                list.addEventListener('mouseover', function (event) {
                    const target = event.currentTarget;
                    const aTag = target.children[0];
                    const divTag = target.children[1];
                    aTag.classList.toggle("show");
                    if (aTag.classList.contains("show")) {
                        aTag.setAttribute("aria-expanded", "true");
                        divTag.classList.add("show");
                        divTag.setAttribute("data-bs-popper", "none");
                    }else {
                        aTag.setAttribute("aria-expanded", "false");
                        divTag.classList.remove("show");
                        divTag.removeAttribute("data-bs-popper");
                    }
                });

                list.addEventListener('mouseout',function (event){
                    const target = event.currentTarget;
                    const aTag = target.children[0];
                    const divTag = target.children[1];
                    if (!aTag.classList.contains("show")) {
                        aTag.setAttribute("aria-expanded", "false");
                        divTag.classList.remove("show");
                        divTag.removeAttribute("data-bs-popper");
                    }else {
                        aTag.classList.remove("show")
                        aTag.setAttribute("aria-expanded", "false");
                        divTag.classList.remove("show");
                        divTag.removeAttribute("data-bs-popper");
                    }
                })
            }

        });


    };

    //TODO async - await 공부 후 적용
    async function setCategoryHeaderList() {
        let data;
        try {
            data = await getParentCategories();

            const headerList = document.getElementById("header-list");
            for (let i = 0; i < data.length; i++) {
                const id = data[i].id;
                const name = data[i].name;

                const list = document.createElement("li");
                const button = document.createElement("a");
                const buttonName = document.createElement("span");

                buttonName.classList.add("nav-link-title");
                buttonName.setAttribute("value", id);
                buttonName.textContent = name;


                button.classList.add("nav-link");
                button.classList.add("dropdown-toggle");
                button.setAttribute("data-bs-auto-close", "outside");
                button.setAttribute("role", "button");
                button.setAttribute("aria-expanded", "false");
                button.href = `#navbar-base`;
                button.appendChild(buttonName);


                const menu = document.createElement("div");
                const menuColumns = document.createElement("div");

                menuColumns.classList.add("dropdown-menu-columns");
                menu.classList.add("dropdown-menu");

                try {
                    const childrenData = await getChildCategoriesByParentId(id);

                    let size = 5;
                    let term = Math.floor(childrenData.length / size) + 1;
                    for (let i = 0; i < term; i++) {
                        let start = size * i;
                        let last = Math.min(start + size, childrenData.length);
                        const menuColumn = document.createElement("div");
                        menuColumn.classList.add("dropdown-menu-column");
                        for (let j = start; j < last; j++) {
                            const innerButton = document.createElement("a");
                            innerButton.classList.add("dropdown-item");
                            //TODO 카테고리 별 조회 리스트 페이지로 넘겨야함
                            innerButton.href = "#"; //"상품페이지url/{categoryId}"
                            innerButton.text = childrenData[j].name;

                            menuColumn.appendChild(innerButton);
                        }
                        menuColumns.appendChild(menuColumn);
                        menu.appendChild(menuColumns);
                    }
                } catch (err){
                    console.error(err);
                }

                list.classList.add("nav-item");
                list.classList.add("dropdown");
                list.appendChild(button);
                list.appendChild(menu);

                headerList.appendChild(list);

            }
        } catch (err) {
            console.error(err);
        }
    }

    function getParentCategories() {
        const responsePromise = fetch(serverCategoryUrl+"/parents", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        });
        return responsePromise.then((resp) => resp.json());
    }

    function getChildCategoriesByParentId(parentId) {
        const responsePromise = fetch(`${serverCategoryUrl}/${id}/children`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        });
        return responsePromise.then((resp) => resp.json());
    }

    const navList = document.getElementsByClassName("nav-item");
    navList.addEventListener('mouseover', function (event) {
        const target = event.currentTarget;
        const aTag = target.children[0];
        const divTag = target.children[1];
        aTag.classList.toggle("show");
        if (aTag.classList.contains("show")) {
            aTag.setAttribute("aria-expanded", "true");
            divTag.classList.add("show");
            divTag.setAttribute("data-bs-popper", "none");
        }else {
            aTag.setAttribute("aria-expanded", "false");
            divTag.classList.remove("show");
            divTag.removeAttribute("data-bs-popper");
        }
    });

    navList.addEventListener('mouseout',function (event){
        const target = event.currentTarget;
        const aTag = target.children[0];
        const divTag = target.children[1];
        if (!aTag.classList.contains("show")) {
            aTag.setAttribute("aria-expanded", "false");
            divTag.classList.remove("show");
            divTag.removeAttribute("data-bs-popper");
        }else {
            aTag.classList.remove("show")
            aTag.setAttribute("aria-expanded", "false");
            divTag.classList.remove("show");
            divTag.removeAttribute("data-bs-popper");
        }
    })
</script>
</body>


</html>
