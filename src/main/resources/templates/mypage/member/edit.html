<!doctype html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.0.0-beta5
* @link https://tabler.io
* Copyright 2018-2022 The Tabler Authors
* Copyright 2018-2022 codecalm.net Paweł Kuna
* Licensed under MIT (https://github.com/tabler/tabler/blob/master/LICENSE)
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>Yes Aladin!</title>
  <!-- CSS files -->
  <link th:href="@{/css/tabler.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-flags.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-payments.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-vendors.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/demo.min.css}" rel="stylesheet"/>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<!-- Libs JS -->
<script type="text/javascript" th:src="@{/libs/apexcharts/dist/apexcharts.min.js}"></script>
<!-- Tabler Core -->
<script type="text/javascript" th:src="@{/js/tabler.min.js}"></script>
<script type="text/javascript" th:src="@{/js/demo.min.js}"></script>

<div class="wrapper">
  <!-- TODO 1 : Head -->
  <div th:replace="~{common/fragments/header :: fragment-header}"></div>
  <!-- TODO 2 : NAV-BAR -->
  <div th:replace="~{common/fragments/navbar :: fragment-nav-bar}"></div>

  <div class="page-wrapper">
    <div class="page-header d-print-none">
      <div class="container-xl">
        <div class="row g-2 align-items-center">
          <div class="col">
            <h2 class="page-title">
              마이 페이지
            </h2>
          </div>
        </div>
      </div>
    </div>
    <div class="page-body">
      <div class="container-xl">
        <div class="card">
          <div class="row g-0">
            <div class="col-xl-3 col-lg-3 bg-secondary-lt">
              <div class="card-body">
                <div th:replace="~{mypage/fragments/sidebar :: fragment-side-bar}"></div>
              </div>
            </div>
            <div class="col-xl-9 col-lg-9">
              <div class="card-body">
                <!-- TODO 3: BODY -->
                <h1 class="fw-bold">회원 정보 수정</h1>

                <div class="card mb-3">
                  <div class="card-header">
                    <h2 class="card-title">계정 정보</h2>
                  </div>
                  <div class="card-body border-bottom py-3">
                    <div class="row mb-2">
                      <div class="col-12">
                        <div class="form-label">아이디</div>
                        <input type="text" class="form-control" th:value="${loginId}" disabled>
                      </div>
                    </div>
                    <div class="row mb-2">
                      <div class="col-12">
                        <div class="form-label">비밀번호</div>
                        <div class="row">
                          <div class="col-10">
                            <input type="password" class="form-control" value="***************"
                                   disabled>
                          </div>
                          <div class="col-2">
                            <a class="btn btn-primary btn-modal w-full"
                               data-bs-toggle="modal" data-bs-target="#modal-password">
                              비밀번호 변경
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="row mb-2">
                      <div class="col-12">
                        <div class="form-label">등급</div>
                        <input type="text" class="form-control" th:value="${grade}" disabled>
                      </div>
                    </div>
                    <div class="row mb-2">
                      <div class="col-12">
                        <div class="form-label">가입일</div>
                        <input type="text" class="form-control" th:value="${signUpDate}" disabled>
                      </div>
                    </div>
                  </div>
                </div>


                <div class="card mb-3">
                  <div class="card-header">
                    <h2 class="card-title">기본 정보</h2>
                  </div>
                  <div class="card-body border-bottom py-3">
                    <div class="row mb-2">
                      <div class="col-10">
                        성명
                        <input type="text" class="form-control" th:value="${name}" disabled>
                      </div>
                      <div class="col-2">
                        성별
                        <input type="text" class="form-control" th:value="${gender}" disabled>
                      </div>
                    </div>

                    <div class="row mb-2">
                      <div class="col-12">
                        <div class="form-label">닉네임</div>
                      </div>

                      <div class="row">
                        <div class="col-10">
                          <input type="text" class="form-control" id="nick-name"
                                 name="nickname" th:value="${nickname}">
                        </div>
                        <div class="col-2">
                          <a class="btn btn-primary btn-modal w-full"
                             data-bs-toggle="modal" data-bs-target="#modal-nickname">
                            닉네임 변경
                          </a>
                        </div>
<!--                        <div class="col-2">-->
<!--                          <input class="btn btn-primary w-full" value="수정하기"-->
<!--                                 onclick="updateNickName();">-->
<!--                        </div>-->
                      </div>
                    </div>

                    <div class="row mb-2">
                      <div class="cor-12">
                        <div class="form-label">이메일</div>
                      </div>

                      <div class="row">
                        <div class="col-10">
                          <input type="text" class="form-control" th:value="${email}" disabled>
                        </div>
                        <div class="col-2">
                          <a class="btn btn-primary btn-modal w-full"
                             data-bs-toggle="modal" data-bs-target="#modal-email">
                            이메일 변경
                          </a>
                        </div>
<!--                        <div class="col-2">-->
<!--                          <input class="btn btn-primary w-full" value="수정하기"-->
<!--                                 onclick="updateNickName();">-->
<!--                        </div>-->
                      </div>
                    </div>

                    <!-- TODO: 전화 번호 추가 -->
                    <div class="row mb-2">
                      <div class="cor-12">
                        <div class="form-label">전화번호</div>
                      </div>

                      <div class="row">
                        <div class="col-10">
                          <input type="text" class="form-control" th:value="${email}" disabled>
                        </div>
                        <div class="col-2">
                          <a class="btn btn-primary btn-modal w-full"
                             data-bs-toggle="modal" data-bs-target="#modal-phone">
                            전화번호 변경
                          </a>
                        </div>
<!--                        <div class="col-2">-->
<!--                          <input class="btn btn-primary w-full" value="수정하기"-->
<!--                                 onclick="updateNickName();">-->
<!--                        </div>-->
                      </div>
                    </div>

                    <div th:replace="~{common/fragments/alert :: custom-alert}"></div>
                    <div th:replace="~{common/utils/success :: custom-success}"></div>
                  </div>
                </div>


              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  <!-- TODO 4 : footer -->
  <div th:replace="~{common/fragments/footer :: fragment-footer}"></div>
</div>
<!--비밀번호 Modal-->
<div class="modal modal-blur fade" id="modal-password"
     tabindex="-1" aria-hidden="true" style="display: none;">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- 비밀번호 Header -->
      <div class="modal-header">
        <h5 class="modal-title">비밀번호 변경</h5>
      </div>
      <!-- 비밀번호 Body -->
      <div class="modal-body">
        <div class="row p-0 w-full" style="height: fit-content">
          <label class="form-label required" for="cur-password"> 현재 비밀번호</label>
          <input type="password" class="form-control required" id="cur-password"
                 placeholder="현재 비밀번호를 입력해주세요" name="currentPwd"
                 pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$"
                 required>
          <div class="valid-feedback">완료</div>
          <div class="invalid-feedback">Password는 최소 8자, 하나 이상의 문자와 하나의 숫자 및 하나의 특수 문자로 입력해주세요.</div>
          <button id="check-current-pwd" type="button" class="btn btn-outline-info"
                  onclick="passwordCheck()">비밀번호 확인
          </button>


          <label class="form-label required" for="new-password"> 새로운 비밀번호</label>
          <input type="password" class="form-control" id="new-password"
                 placeholder="Password는 최소 8자, 하나 이상의 문자와 하나의 숫자 및 하나의 특수 문자로 입력해주세요."
                 name="new-password"
                 pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$"
                 onchange="validatePassword()"
                 required disabled>
          
          <label class="form-label required" for="new-password-check"> 새로운 비밀번호 확인</label>
          <input type="password" class="form-control" id="new-password-check"
                 placeholder="Password는 최소 8자, 하나 이상의 문자와 하나의 숫자 및 하나의 특수 문자로 입력해주세요."
                 name="new-password-check"
                 pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$"
                 onchange="validatePassword()"
                 required disabled>
        </div>
      </div>
      <hr class="mt-0 mb-1">
      <!-- 비밀번호 Footer -->
      <div class="modal-footer" id="member-address-footer">
        <div class="row w-full ms-0 me-0">
          <div class="col-12 ps-0 pe-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">닫기</button>
<!--            <button type="submit" class="btn btn-primary">변경하기</button>-->
            <button type="button" class="btn btn-info link-secondary"
                    onclick="updatePassword()">
              변경하기
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--닉네임 변경 Modal-->
<div class="modal modal-blur fade" id="modal-nickname"
     tabindex="-1" aria-hidden="true" style="display: none;">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">닉네임 변경</h5>
      </div>
      <!-- body -->
      <div class="modal-body">
        <form action="/members/nickname" class="was-validated"
              method="post">
          <br/>
          <div class="form-group">
            <label for="exchangeNickname">변경할 닉네임</label>
            <input type="text" class="form-control" id="exchangeNickname"
                   placeholder="숫자, 영어, 한국어와 언더스코어를 허용하며 최소 2자 이상의 15자 이하의 닉네임만 가능합니다." name="exchangeNickname"
                   pattern="^[가-힣ㄱ-ㅎa-zA-Z0-9._-]{2,15}$"
                   required>
            <div class="valid-feedback">완료</div>
            <div class="invalid-feedback">닉네임 형식에 맞지않습니다.</div>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">닫기</button>
          <button type="submit" class="btn btn-primary">변경하기</button>
        </form>
      </div>
    </div>
  </div>
</div>
<!--닉네임 변경 Modal-->


<!--이메일 변경 Modal-->
<div class="modal modal-blur fade" id="modal-email"
     tabindex="-1" aria-hidden="true" style="display: none;">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">이메일 변경</h5>
      </div>
      <!-- body -->
      <div class="modal-body">
        <form action="/members/email" class="was-validated"
              method="post">
          <br/>
          <div class="form-group">
            <label for="exchangeEmail">변경할 이메일</label>
            <input type="email" class="form-control" id="exchangeEmail"
                   placeholder="abc@xxxx.xxx" name="exchangeEmail"
                   pattern="^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$"
                   required>
            <div class="valid-feedback">완료</div>
            <div class="invalid-feedback">이메일 형식에 맞지않습니다.</div>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">닫기</button>
          <button type="submit" class="btn btn-primary">변경하기</button>
        </form>
      </div>
    </div>
  </div>
</div>
<!--이메일 변경 Modal-->


<!--전화번호 변경 Modal-->
<div class="modal modal-blur fade" id="modal-phone"
     tabindex="-1" aria-hidden="true" style="display: none;">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">전화번호 변경</h5>
      </div>
      <!-- body -->
      <div class="modal-body">
        <form action="/members/phone" class="was-validated"
              method="post">
          <br/>
          <div class="form-group">
            <label for="exchangePhone">변경할 전화번호</label>
            <input type="text" class="form-control" id="exchangePhone"
                   placeholder="휴대폰 번호 ex) 01012345678" name="exchangePhone"
                   pattern="/^01([0|1])\d{4}\d{4}$/" maxlength="11"
                   oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                   required>
            <div class="valid-feedback">완료</div>
            <div class="invalid-feedback">전화번호 형식에 맞지않습니다.</div>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">닫기</button>
          <button type="submit" class="btn btn-primary">변경하기</button>
        </form>
      </div>
    </div>
  </div>
</div>
<!--전화번호 변경 Modal-->


</body>
<script th:inline="javascript">
  const frontUrl = [[${@environment.getProperty('yesaladin.front.url')}]];

  const nickName = document.getElementById("nick-name");

  function updateNickName() {
    const nickname = nickName.value;
    console.log("nickname : " + nickname);
    if (nickname == "") {
      writeContentToAlert("변경하고 싶은 닉네임을 입력하세요.");
      return;
    }
    fetch(`${frontUrl}/api/members/edit`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        nickname: nickname
      })
    }).then((resp) => {
      resp.json()
    }).then((data) => {
      console.log("data : ", data);
      if (data) {
        writeContentToAlert("회원 정보를 수정하는데 실패했습니다.");
        nickName.value = [[${nickname}]];
      } else {
        writeContentToSuccess("회원 정보가 수정되었습니다.");
      }
    })
  }

  const curPassword = document.getElementById("cur-password");
  let newPassword = document.getElementById("new-password");
  let newPasswordCheck = document.getElementById("new-password-check");

  // TODO: controller와 연결 후 API 서버에 해당 API 추가해야 함. (encoding 된 password를 조회한 뒤 passwordEncoder.matches()로 비교하면 됨
  function passwordCheck() {
    const curPassword = document.getElementById("cur-password").value;
    $.ajax({
      type: "post",
      async: false,
      dataType: 'json',
      data: {curPassword: curPassword},
      url: "/members/password-check"
      , success: function (result) {
        if (result === true) {
          alert("비밀번호 확인 완료")
          document.getElementById("new-password").disabled = false;
          document.getElementById("new-password-check").disabled = false;
          document.getElementById("cur-password").disabled = true;
          document.getElementById("check-current-pwd").disabled = true;
        } else {
          alert("비밀번호가 일치하지 않습니다.")
        }
      }
    })
  }
  
  function validatePassword() {
    if (newPassword.value !== newPasswordCheck.value) {
      newPasswordCheck.setCustomValidity("패스워드가 일치하지 않습니다.");
    } else {
      newPasswordCheck.setCustomValidity('');
    }
  }

  // TODO: 아래는 망한 코드... 다 뜯어 고쳐야 함
  newPassword.onchange = validatePassword;
  newPasswordCheck = validatePassword;

  function updatePassword() {
    // const nickname = nickName.value;
    // console.log("nickname : " + nickname);
    // if (nickname == "") {
    //   writeContentToAlert("변경하고 싶은 닉네임을 입력하세요.");
    //   return;
    // }
    // fetch(`${frontUrl}/api/members/edit`, {
    //   method: "PUT",
    //   headers: {
    //     "Content-Type": "application/json"
    //   },
    //   body: JSON.stringify({
    //     nickname: nickname
    //   })
    // }).then((resp) => {
    //   resp.json()
    // }).then((data) => {
    //   console.log("data : ", data);
    //   if (!data) {
    //     writeContentToAlert("회원 정보를 수정하는데 실패했습니다.");
    //     nickName.value = [[${nickname}]];
    //   } else {
    //     writeContentToSuccess("회원 정보가 수정되었습니다.");
    //   }
    // })
  }
</script>
</html>
