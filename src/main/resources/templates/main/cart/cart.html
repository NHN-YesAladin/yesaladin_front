<!DOCTYPE html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.0.0-beta5
* @link https://tabler.io
* Copyright 2018-2022 The Tabler Authors
* Copyright 2018-2022 codecalm.net Paweł Kuna
* Licensed under MIT (https://github.com/tabler/tabler/blob/master/LICENSE)
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>Yes Aladin!</title>
  <!-- CSS files -->
  <link th:href="@{/css/tabler.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-flags.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-payments.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-vendors.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/demo.min.css}" rel="stylesheet"/>
</head>
<body>
<!-- Libs JS -->
<script type="text/javascript" th:src="@{/libs/apexcharts/dist/apexcharts.min.js}"></script>
<!-- Tabler Core -->
<script type="text/javascript" th:src="@{/js/tabler.min.js}"></script>
<script type="text/javascript" th:src="@{/js/demo.min.js}"></script>

<div class="wrapper">

  <!-- TODO 1 : HEADER -->
  <div th:replace="~{common/fragments/header :: fragment-header}"></div>

  <!-- TODO 2 : NAV-BAR -->
  <div th:replace="~{common/fragments/navbar :: fragment-nav-bar}"></div>

  <!-- TODO 3: BODY -->
  <div class="page-body container-xl">
    <div class="card">
      <div class="card-header row">
        <div style="justify-content: space-between;" class="row">
          <!-- 스텝 -->
          <div style="width: 400px">
            <ul class="steps steps-blue steps-counter my-4">
              <li class="step-item active">카트</li>
              <li class="step-item">주문</li>
              <li class="step-item">결제</li>
              <li class="step-item">완료</li>
            </ul>
          </div>

          <!-- 나의 계좌 -->
          <div style="width: 200px" class="d-flex align-items-center">
            <dl>
              <dt class="d-inline m-1 p-1">
                <div class="avatar bg-blue-lt">
                  나의
                  <br/>
                  계좌
                </div>
              </dt>
              <dd class="d-inline m-1">
                <div class="avatar text-blue bg-transparent">
                  포인트
                  <br/>
                  0원
                </div>
              </dd>
              <dd class="d-inline m-1">
                <div class="avatar text-blue bg-transparent">
                  쿠폰
                  <br/>
                  0개
                </div>
              </dd>
            </dl>
          </div>
        </div>

        <!-- 전체선택/ 주문/ 삭제 -->
        <div>
          <label class="form-check form-check-inline ms-2">
            <input class="form-check-input" type="checkbox" id="all-check">
            <span class="form-check-label">전체선택</span>
          </label>
          <a href="#" class="btn btn-primary btn-pill">
            주문하기
          </a>
          <a href="#" class="btn btn-light btn-pill">
            삭제
          </a>
        </div>

      </div>

      <div class="card-body">
        <!-- 배송상품 -->
        <div class="mt-3">
          <div style="justify-content: space-between;" class="row">
            <h2 style="width: 300px;">
              <em><strong>Yes!Aladin 배송</strong></em>
            </h2>
            <div style="width: 200px;" class="mx-2">
              <div class="text-end text-muted">
                20,000원 이상 구매 시 무료배송
              </div>
            </div>
          </div>
          <div>
            <table class="table table-vcenter" style="width: 100%;">
              <colgroup>
                <col style="width: 40px;">
                <col style="width: 100px;">
                <col>
                <col style="width: 70px;">
                <col style="width: 120px;">
                <col style="width: 90px;">
              </colgroup>
              <thead>
                <tr>
                  <th colspan="3" scope="col">
                    <div class="d-flex justify-content-center">
                      상품정보
                    </div>
                  </th>
                  <th scope="col">
                    <div class="d-flex justify-content-center">
                      수량
                    </div>
                  </th>
                  <th scope="col">
                    <div class="d-flex justify-content-center">
                      상품금액
                    </div>
                  </th>
                  <th scope="col">
                    <div class="d-flex justify-content-center">
                      주문
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="product : ${deliveryCart}">
                  <td>
                    <div class="d-flex justify-content-center">
                      <input th:id="${product.getId()}" th:value="${product.getId()}" name="chkDeliveryCart" type="checkbox" autocapitalize="off"
                             th:onclick="|selectProduct('Delivery', ${product.getId()})|" checked>
                    </div>
                  </td>
                  <td>
                    <a th:href="@{'/products/' + ${product.getId()}}" target="_new" >
                      <img th:src="${product.getThumbnailFileUrl()}" alt="">
                    </a>
                  </td>
                  <td>
                    <div>
                      <a th:href="@{'/products/' + ${product.getId()}}" th:text="${'[도서] ' + product.getTitle()}" target="_blank"></a>
                    </div>
                    <div>
                      <span><del th:text="${#numbers.formatInteger(product.getActualPrice(), 1, 'COMMA')} + '원'"></del></span>
                      <span><em th:id="'productSellingPrice' + ${product.getId()}" th:text="${#numbers.formatInteger(product.getSellingPrice(), 1, 'COMMA')}"></em>원</span>
                      <span th:text="'(' + ${#numbers.formatInteger(product.getDiscountRate(), 1, 'COMMA')} + '% 할인)'"></span>
                      <span class="ms-2"><span class="badge bg-blue-lt">P</span><span th:id="productPoint + ${product.getId()}" th:text="${#numbers.formatInteger(product.getPointPrice(), 1, 'COMMA')} + '원'"></span></span>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex justify-content-center mb-2">
                      <span>
                        <input class="form-control" th:id="'quantity' + ${product.id}" type="number"
                               th:value="${product.getQuantity()}" min="1" maxlength="4" style="width: 60px; height: 30px;">
                        <input type="hidden" th:id="hiddenQuantity + ${product.getId()}" th:value="${product.getQuantity()}" name="deliveryProductQuantity">
                      </span>
                    </div>
                    <div class="d-flex justify-content-center">
                      <a href="#" class="btn btn-outline-primary" style="height: 20px" th:onclick="|modifyQuantity(${product.getId()})|">
                        변경
                      </a>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex justify-content-center">
                      <strong th:id="'productTotalPrice' + ${product.getId()}" th:text="${#numbers.formatInteger(product.getSellingPrice() * product.getQuantity(), 1, 'COMMA')} + '원'"></strong>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex justify-content-center mb-2">
                      <a href="#" class="btn btn-primary btn-pill" style="width: 70px; height: 30px;">
                        주문하기
                      </a>
                    </div>
                    <div class="d-flex justify-content-center">
                      <button type="button" class="btn btn-light btn-pill" th:onclick="|deleteInCart(${product.getId()})|" style="width: 70px; height: 30px;">
                        삭제
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="6">
                    <div class="text-end px-1">
                      Yes!Aladin 배송 상품 총 금액 :<strong id="totalAmountDeliveryProductCart"></strong>
                      <span>( + 배송비 <strong id="totalDeliveryCost"></strong>)</span>
                      <span class="mx-2">|</span>
                      YES!Aladin 포인트 총 적립액 :<strong id="totalPointDeliveryProductCart"></strong>
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <!-- eBook -->
        <div class="mt-5" th:if="${eBookCart.size() > 0}">
          <div style="justify-content: space-between;" class="row">
            <h2 style="width: 300px;">
              <em><strong>Yes!Aladin E-book 카트</strong></em>
            </h2>
            <div style="width: 400px;" class="mx-2">
              <div class="text-end text-muted">
                eBook상품(무배송)은 구매 후 다운로드 시 취소/환불 불가
              </div>
            </div>
          </div>
          <div>
            <table class="table table-vcenter" style="width: 100%;">
              <colgroup>
                <col style="width: 40px;">
                <col style="width: 100px;">
                <col>
                <col style="width: 70px;">
                <col style="width: 120px;">
                <col style="width: 90px;">
              </colgroup>
              <thead>
              <tr>
                <th colspan="3" scope="col">
                  <div class="d-flex justify-content-center">
                    상품정보
                  </div>
                </th>
                <th scope="col">
                  <div class="d-flex justify-content-center">
                    수량
                  </div>
                </th>
                <th scope="col">
                  <div class="d-flex justify-content-center">
                    상품금액
                  </div>
                </th>
                <th scope="col">
                  <div class="d-flex justify-content-center">
                    주문
                  </div>
                </th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="product : ${eBookCart}">
                <td>
                  <div class="d-flex justify-content-center">
                    <input th:id="${product.id}" th:value="${product.id}" name="chkEbookCart" type="checkbox" autocapitalize="off">
                  </div>
                </td>
                <td>
                  <a th:href="@{'/products/' + ${product.id}}" target="_new" >
                    <img th:src="${product.getThumbnailFileUrl()}" alt="">
                  </a>
                </td>
                <td>
                  <div>
                    <a th:href="@{'/products/' + ${product.id}}" th:text="${'[eBook] ' + product.getTitle()}" target="_blank"></a>
                  </div>
                  <div>
                    <span><del th:text="${#numbers.formatInteger(product.getActualPrice(), 1, 'COMMA')} + '원'"></del></span>
                    <span><em th:id="'productSellingPrice' + ${product.getId()}" th:text="${#numbers.formatInteger(product.getSellingPrice(), 1, 'COMMA')}"></em>원</span>
                    <span th:text="'(' + ${#numbers.formatInteger(product.getDiscountRate(), 1, 'COMMA')} + '% 할인)'"></span>
                    <span class="ms-2"><span class="badge bg-blue-lt">P</span><span th:text="${#numbers.formatInteger(product.getPointPrice(), 1, 'COMMA')} + '원'"></span></span>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center mb-2">
                      1
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center">
                    <strong th:id="'productTotalPrice' + ${product.getId()}" th:text="${#numbers.formatInteger(product.getSellingPrice(), 1, 'COMMA')} + '원'"></strong>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center mb-2">
                    <a href="#" class="btn btn-primary btn-pill" style="width: 70px; height: 30px;">
                      주문하기
                    </a>
                  </div>
                  <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-light btn-pill" th:onclick="|deleteInCart(${product.getId()})|" style="width: 70px; height: 30px;">
                      삭제
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
              <tfoot>
              <tr>
                <td colspan="6">
                  <div class="text-end px-1">
                    Yes!Aladin eBook 상품 총 금액 :<strong id="totalAmountDeliveryEbookCart">0원</strong>
                    <span class="mx-2">|</span>
                    YES!Aladin 포인트 총 적립액 :<strong id="totalPointDeliveryEbookCart">0원</strong>
                  </div>
                </td>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <!-- 정기구독 상품 -->
        <div class="mt-5" th:if="${subscribeCart.size() > 0}">
          <div style="justify-content: space-between;" class="row">
            <h2 style="width: 300px;">
              <em><strong>Yes!Aladin 정기구독</strong></em>
            </h2>
            <div style="width: 500px;" class="mx-2">
              <div class="text-end text-muted">
                정기구독 상품 구매 시 최소 6개월, 최대 1년 후 자동 정기 결제
              </div>
            </div>
          </div>
          <div>
            <table class="table table-vcenter my-0" style="width: 100%;">
              <colgroup>
                <col style="width: 40px;">
                <col style="width: 100px;">
                <col>
                <col style="width: 70px;">
                <col style="width: 120px;">
                <col style="width: 90px;">
              </colgroup>
              <thead>
              <tr>
                <th colspan="3" scope="col">
                  <div class="d-flex justify-content-center">
                    상품정보
                  </div>
                </th>
                <th scope="col">
                  <div class="d-flex justify-content-center">
                    수량
                  </div>
                </th>
                <th scope="col">
                  <div class="d-flex justify-content-center">
                    상품금액
                  </div>
                </th>
                <th scope="col">
                  <div class="d-flex justify-content-center">
                    주문
                  </div>
                </th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="product : ${subscribeCart}">
                <td>
                  <div class="d-flex justify-content-center">
                    <input th:id="${product.id}" th:value="${product.id}" name="chkSubscribeCart" type="checkbox" autocapitalize="off">
                  </div>
                </td>
                <td>
                  <a th:href="@{'/products/' + ${product.id}}" target="_new" >
                    <img th:src="${product.getThumbnailFileUrl()}" alt="">
                  </a>
                </td>
                <td>
                  <div>
                    <a th:href="@{'/products/' + ${product.id}}" th:text="${'[정기구독] ' + product.getTitle()}" target="_blank"></a>
                  </div>
                  <div>
                    <span><del th:text="${#numbers.formatInteger(product.getActualPrice(), 1, 'COMMA')} + '원'"></del></span>
                    <span><em th:id="'productSellingPrice' + ${product.getId()}" th:text="${#numbers.formatInteger(product.getSellingPrice(), 1, 'COMMA')}"></em>원</span>
                    <span th:text="'(' + ${#numbers.formatInteger(product.getDiscountRate(), 1, 'COMMA')} + '% 할인)'"></span>
                    <span class="ms-2"><span class="badge bg-blue-lt">P</span><span th:text="${#numbers.formatInteger(product.getPointPrice(), 1, 'COMMA')} + '원'"></span></span>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center mb-2">
                      <span>
                        1
                      </span>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center">
                    <strong th:id="'productTotalPrice' + ${product.getId()}" th:text="${#numbers.formatInteger(product.getSellingPrice(), 1, 'COMMA')} + '원'"></strong>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center mb-2">
                    <a href="#" class="btn btn-primary btn-pill" style="width: 70px; height: 30px;">
                      주문하기
                    </a>
                  </div>
                  <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-light btn-pill" th:onclick="|deleteInCart(${product.getId()})|" style="width: 70px; height: 30px;">
                      삭제
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
              <tfoot>
              <tr>
                <td colspan="6">
                  <div class="text-end px-1">
                    Yes!Aladin 정기구독 상품 총 금액 :<strong id="totalAmountSubscriptionProductCart">0원</strong>
                    <span class="mx-2">|</span>
                    YES!Aladin 포인트 총 적립액 :<strong id="totalPointSubscriptionProductCart">0원</strong>
                  </div>
                </td>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="pt-4 px-2 text-end bg-azure-lt" th:if="${!(eBookCart.size() == 0 && subscribeCart.size() == 0)}">
          <div class="pb-3 text-blue">
            <strong>Yes!Aladin 배송<label> + eBook 카트</label><label> + 정기구독 카트</label></strong>
            상품 총 금액 :<strong><em class="text-dark" id="totalAmountCartYesAladinCart">0원</em></strong> <span class="mx-2">|</span>
            Yes!Aladin 포인트 총 적립액 :<strong id="totalPointCartYesAladinCart">0원</strong>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- 선택/ 주문/ 삭제 -->
        <div class="pt-2">
          <label class="form-check form-check-inline ms-2">
            <span class="form-check-label">선택한 상품</span>
          </label>
          <a href="#" class="btn btn-primary btn-pill">
            주문하기
          </a>
          <a href="#" class="btn btn-light btn-pill">
            삭제
          </a>
        </div>
        <!-- 결제 금액 예상 -->
        <table class="table table-vcenter card-table mt-3">
          <thead>
            <tr>
              <th scope="col" style="font-size: 10pt; ">
                <div class="d-flex justify-content-center">
                  총 상품금액
                </div></th>
              <th></th>
              <th scope="col" class="saleCol" style="font-size: 10pt;">
                <div class="d-flex justify-content-center">
                  총 할인금액
                </div></th>
              <th></th>
              <th scope="col" class="priceCol lastCol" style="font-size: 10pt;">
                <div class="d-flex justify-content-center">
                  최종 결제금액
                </div></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="font-size: 15pt;">
                <em class="yes_b d-flex justify-content-center">64,580원</em>
              </td>
              <td style="font-size: 15pt;">
                <em class="icon_settle ico_settle_minus d-flex justify-content-center">-</em>
              </td>
              <td class="saleCol" style="font-size: 15pt;"><em class="yes_b d-flex justify-content-center">0원</em>
              </td>
              <td style="font-size: 15pt;">
                <em class="icon_settle ico_settle_equal d-flex justify-content-center">=</em>
              </td>
              <td class="priceCol lastCol" style="font-size: 15pt;"><em class="yes_b d-flex justify-content-center">64,580원</em></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TODO 4 : footer -->
  <div th:replace="~{common/fragments/footer :: fragment-footer}"></div>

</div>
</div>
<script>
  function deleteInCart(id) {
    fetch('/cart/' + id, {
      method: "DELETE"
    }).finally(() => window.location.reload());
  }

  function modifyQuantity(id) {
    const quantity = document.getElementById('quantity' + id).value;

    fetch('/cart/' + id, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        "quantity": quantity
      })
    }).then(() => {
      window.location.reload();
    });
  }
</script>
<script th:inline="javascript">
  const deliveryCart = [[${deliveryCart}]];
  const eBookCart = [[${eBookCart}]];
  const subscribeCart = [[${subscribeCart}]];

  // 배달 상품
  const totalAmountDeliveryProductCart = document.getElementById('totalAmountDeliveryProductCart');
  const totalDeliveryCost = document.getElementById('totalDeliveryCost');
  const totalPointDeliveryProductCart = document.getElementById('totalPointDeliveryProductCart');

  // 전체 상품
  const totalAmountCartYesAladinCart = document.getElementById('totalAmountCartYesAladinCart');
  const totalPointCartYesAladinCart = document.getElementById('totalPointCartYesAladinCart');

  document.addEventListener('DOMContentLoaded', () => {
    // 배달 상품
    let totalAmountDeliveryProduct = 0;
    let totalPointDeliveryProduct = 0;

    deliveryCart.forEach(value => {
      totalAmountDeliveryProduct += value.sellingPrice * value.quantity;
      totalPointDeliveryProduct += value.pointPrice * value.quantity;
    });

    totalAmountDeliveryProductCart.innerText = totalAmountDeliveryProduct.toLocaleString() + "원";
    totalDeliveryCost.innerText = totalAmountDeliveryProduct >= 20000 ? "0원" : "3,000원";
    totalPointDeliveryProductCart.innerText = totalPointDeliveryProduct.toLocaleString() + "원";

    // 전체 상품
    if (Object.keys(eBookCart).length !== 0 && Object.keys(subscribeCart).length !== 0) {
      totalAmountCartYesAladinCart.innerText = totalAmountDeliveryProduct.toLocaleString() + "원";
      totalPointCartYesAladinCart.innerText = totalPointDeliveryProduct.toLocaleString() + "원";
    }
  });
</script>
<script th:inline="javascript">
  function selectProduct(type, id) {
    let checkBox = document.getElementById(id);

    const totalAmountProductCart = document.getElementById('totalAmount' + type + 'ProductCart');
    const totalPointProductCart = document.getElementById('totalPoint' + type + 'ProductCart');
    const totalDeliveryCost = document.getElementById('totalDeliveryCost');

    let productTotalPrice;
    let productPoint = Number(document.getElementById('productPoint' + id).innerText.replaceAll(/,|원/g, ""));

    if (checkBox.checked === true) {
      // 상품의 전체 금액 (+)
      productTotalPrice = Number(totalAmountProductCart.innerText.replaceAll(/,|원/g, ""))
              + Number(document.getElementById('productTotalPrice' + id).innerText.replaceAll(/,|원/g, ""));

      // 배송 상품인 경우
      if (type === 'Delivery') {
        productPoint = Number(document.getElementById('hiddenQuantity' + id).value) * productPoint;
        totalDeliveryCost.innerText = productTotalPrice >= 20000 || productTotalPrice <= 0 ? "0원" : "3,000원";
      }

      // 상품의 전체 포인트 (+)
      totalPointProductCart.innerText = (Number(totalPointProductCart.innerText.replaceAll(/,|원/g, "")) + productPoint).toLocaleString() + "원";
    } else {
      // 상품의 전체 금액 (-)
      productTotalPrice = Number(totalAmountProductCart.innerText.replaceAll(/,|원/g, ""))
              - Number(document.getElementById('productTotalPrice' + id).innerText.replaceAll(/,|원/g, ""));

      // 배송 상품인 경우
      if (type === 'Delivery') {
        productPoint = Number(document.getElementById('hiddenQuantity' + id).value) * productPoint;
        totalDeliveryCost.innerText = productTotalPrice >= 20000 || productTotalPrice <= 0 ? "0원" : "3,000원";
      }

      // 상품의 전체 포인트 (-)
      totalPointProductCart.innerText = Number(totalPointProductCart.innerText.replaceAll(/,|원/g, "")) - productPoint >= 0 ?
              (Number(totalPointProductCart.innerText.replaceAll(/,|원/g, "")) - productPoint).toLocaleString() + "원" : "0원"
    }

    totalAmountProductCart.innerText = productTotalPrice.toLocaleString() + "원";
  }
</script>
</body>
</html>
