<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<body th:fragment="order-sheet">
<!--토스 결제창을 위해 무조건 제일 위에서 load 되어야함-->
<script src="https://js.tosspayments.com/v1/payment"></script>
<form method="post" th:action="@{'/order' + ${member == null ? '/non-member': '/member'}}">
  <div class="container-narrow py-4">
    <div class="text-center mb-4">
      <h1 class="h-auto">주문서</h1>
      <!--    <a href="." class="navbar-brand navbar-brand-autodark"><img src="./static/logo.svg" height="36" alt=""></a>-->
    </div>
    <div class="card card-md">
      <div class="card-body">
        <ul class="steps steps-blue steps-counter">
          <li class="step-item">카트</li>
          <li class="step-item active">주문</li>
          <li class="step-item">결제</li>
          <li class="step-item">완료</li>
        </ul>
      </div>
      <div class="card-body">
        <h3 class="card-title">주문자 정보 입력</h3>
        <div class="card card-md">
          <div class="card-body">
            <label class="form-label required">주문인</label>
            <input type="text" class="form-control" name="orderer" placeholder="홍길동"
                   th:disabled="${name != null}" th:value="${name}">
            <label class="form-label required mt-2">전화번호</label>
            <input type="text" class="form-control" name="orderer-phone-number" id="phone-number"
                   maxlength="11" data-mask="000 0000 0000"
                   placeholder="띄어쓰기 없이 붙여주세요.(ex: 01012341234)"
                   data-mask-visible="true" autocomplete="off"
                   th:disabled="${phoneNumber != null}" th:value="${phoneNumber}">
          </div>
        </div>
        <br>
        <h3 class="card-title">배송 정보 입력</h3>
        <div class="card card-md">
          <div class="card-body">
            <div>
              <label class="form-label required d-lg-inline float-start">주소</label>
              <a sec:authorize="isAuthenticated()"
                 class="btn btn-outline-secondary btn-sm float-end btn-modal"
                 data-bs-toggle="modal" data-bs-target="#modal-report">
                배송지 선택
              </a>
              <button sec:authorize="!isAuthenticated()" type="button"
                      class="btn btn-outline-secondary btn-sm float-end" onclick="getAddress();">
                우편번호 찾기
              </button>
            </div>
            <input type="text" name="orderer-address-id" hidden="hidden">
            <div class="w-full">
              <input type="text" class="form-control col-3" name="orderer-post-address"
                     placeholder="우편번호" th:value="${address}" disabled>
              <input type="text" class="form-control col-9" name="orderer-road-address"
                     placeholder="도로명 주소" th:value="${address}" disabled>
            </div>
            <input type="text" class="form-control" name="orderer-detail-address"
                   placeholder="상세 주소" th:value="${address}">

            <label class="form-label d-lg-inline float-start mt-2">희망배송날짜</label>
            <input class="form-control mb-2" type="date" name="order-expected-date"
                   th:min="${#calendars.format( #calendars.createNow(), 'yyyy-MM-dd')}"
                   id="datepicker">
            <span class="form-check-description">미선택시 가장 가까운 날로 배송될 예정입니다.</span>
          </div>
        </div>
        <br>
        <h3 class="card-title">주문 상품 정보</h3>
        <div class="card card-md">
          <div class="table-responsive">
            <table
                class="table table-vcenter text-center scroll-x">
              <thead>
              <tr>
                <th class="w-1"></th>
                <th>상품번호</th>
                <th>상품명</th>
                <th>가격</th>
                <th>적립예정포인트</th>
                <th>수량</th>
                <th>개별쿠폰 적용</th>
              </tr>
              </thead>
              <tbody th:each="product:${products}">
              <tr>
                <td th:text="${productStat.index + 1}"></td>
                <td><span name="order-product" th:value="${product.isbn}"
                          th:text="${product.isbn}"></span></td>
                <td th:text="${product.title}"></td>
                <td>
                  <del class="fs-6" th:text="${product.actualPrice}"></del>
                  <span class="text-danger"
                        th:text="${product.actualPrice * (100 - product.discountRate) / 100}"></span>
                </td>
                <td th:text="${product.expectedPoint}"></td>
                <td>
                  <span name="order-product-quantity" th:value="${product.quantity}"
                        th:text="${product.quantity}"></span>
                </td>
                <td>
                  <!--                  TODO 개별 쿠폰 적용하기-->
                  <button type="button" class="btn btn-outline-secondary btn-sm float-end">쿠폰 적용
                  </button>
                  <span hidden="hidden">
                    <button type="button"
                            class="btn btn-outline-danger btn-sm float-end">쿠폰 취소</button>
                    <span name="order-product-price">할인된 금액</span>
                  </span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="float-end"> 결제 예상 금액 : <span id="expected-purchase-amount">50000</span>원</div>
        <br>
        <h3 class="card-title">추가할인</h3>
        <div class="card card-md">
          <div class="card-body">
            <div class="form-label">
              <!--             TODO  전체/카테고리 쿠폰-->
              전체/카테고리 쿠폰 적용
              <button type="button" class="btn btn-outline-secondary btn-sm">쿠폰 선택</button>
              <span class="float-end w-auto">
                - <input class="form-control form-control-sm w-auto" style="display:inline"
                         id="coupon-applied-amount" value="0" readonly type="text"> 원
               </span>
            </div>
            <!--            TODO 사용한 쿠폰 목록 보여주기-->
            <div id="used-coupons"></div>
          </div>
          <div class="card-body">
            <div class="form-group mb-3 row">
              <label class="form-label col-3 col-form-label">포인트 적용</label>
              <div class="col text-end">
                - <input class="form-control form-control-sm w-auto" style="display: inline"
                         id="point-applied-amount" value="0" type="text" numberOnly
                         oninput="pointOverCheck(this)"
                         onchange="pointValidCheck(this)"> 원
              </div>
              <small class="float-end" style="color: #c13333" id="point-alert" hidden="hidden">
                값을 입력해주세요.
              </small>
              <small style="float:right;" class="form-hint text-end">
                사용가능한 포인트 :
                <span id="owned_point" type="text" th:text="${userPoint}"></span> 원 (1000원 단위로 사용가능)
              </small>
            </div>
          </div>
        </div>
        <br>
        <h3 class="card-title">
          총 상품 금액
          <span style="float: right">원</span>
          <span style="float: right" id="total-product-price">0</span>
        </h3>
        <div class="hr-text">결제 금액</div>
        <div class="card-body border-0">
          <small style="float:right;">배달비 : <span id="shipping-fee"></span> 원</small>
        </div>
        <div class="card-body border-0">
          <span style="float: right">
            <label class="form-check form-switch" style="display: inline">
              <input class="form-check-input" id="wrapping-check" type="checkbox" value="0"
                     style="display: inline">
            </label>
            <small class="float-end">포장비 : 3000원</small>
          </span>
        </div>
        <br>
        <h3 class="card-title">
          총 결제 금액
          <span style="float: right">원</span>
          <span style="float: right" id="total-price">0</span>
        </h3>
      </div>
    </div>
    <div class="mt-2">
      <a href="#" class="btn btn-primary w-100" onclick="produceOrder(this)">
        결제
      </a>
      <div th:replace="~{common/fragments/alert :: custom-alert}"></div>
    </div>
  </div>
</form>
<div th:replace="~{main/order/address-modal :: adderss-modal}"></div>
<div class="d-none" id="shop-server-url"
     th:text="${@environment.getProperty('yesaladin.gateway.shop')}"></div>
<div class="d-none" id="front-server-url"
     th:text="${@environment.getProperty('yesaladin.front.url')}"></div>

<script th:inline="javascript">
  let FRONT_SERVER;
  let SHOP_SERVER;

  const clientKey = "test_ck_YPBal2vxj81jnwPmEXA35RQgOAND"; // 상점을 구분하는 키
  const tossPayments = TossPayments(clientKey); // SDK 초기화

  (function init() {
    initConnectionInfo();
  })();

  function initConnectionInfo() {
    FRONT_SERVER = document.querySelector("#front-server-url").textContent;
    SHOP_SERVER = document.querySelector("#shop-server-url").textContent;
  }

  /*<![CDATA[*/
  function pointOverCheck(e) {
    const alert = document.getElementById("point-alert");
    const expectedPrice = parseInt(document.getElementById("expected-purchase-amount").innerText);
    const userPoint = /*[[${userPoint}]]*/;
    var curPoint = parseInt(e.value);
    alert.hidden = true;
    if (e.value === "") {
      alert.hidden = false;
    }
    if (curPoint > userPoint) {
      curPoint = userPoint;
    }
    if (curPoint > expectedPrice) {
      curPoint = expectedPrice;
    }
    e.value = curPoint;
  }

  function pointValidCheck(e) {
    var amount = e.value;
    if (e.value === "" || e.value < 0) {
      amount = 0;
      document.getElementById("point-alert").hidden = true;
    } else if (e.value % 1000 > 0) {
      amount = parseInt(e.value / 1000) * 1000;
    }
    e.value = amount;
    setTotalPrice();
  }

  document.getElementById("wrapping-check").addEventListener('change', function () {
    if (this.checked) {
      this.value = 3000;
    } else {
      this.value = 0;
    }
    setTotalPrice();
  });

  function produceOrder(e) {
    // TODO 주문, 배송 , 쿠폰 관련 처리를 위한 클릭 이벤트 함수

    //결제 시퀀스 - 임시 변수 입력중
    const orderResp = {};
    processPayment(orderResp);

  }

  function processPayment(orderResp) {
    let randomON = `0000_${new Date().getDate()}_${new Date().getHours()}_${new Date().getMinutes()}_${new Date().getMilliseconds()}`;
    orderResp["orderId"] = 12421345325;
    orderResp["orderNumber"] = randomON;
    let realOrderName = "테스트 주문 외 4권";
    orderResp["orderName"] = encodeURI(realOrderName);
    orderResp["totalAmount"] = 100000;
    orderResp["shippingFee"] = 3000;
    orderResp["wrappingFee"] = 2000;

    let orderId = orderResp["orderId"];
    let orderNumber = orderResp["orderNumber"];
    let orderName = orderResp["orderName"];
    let totalAmount = orderResp["totalAmount"] + orderResp["shippingFee"]
        + orderResp["wrappingFee"];
    // console.log(decodeURI(orderName))

    let successUrl = `${FRONT_SERVER}/payments/order-pay`;
    let failUrl = `${FRONT_SERVER}/payments/fail?o-num=${orderNumber}&o-name=${orderName}&o-amount=${totalAmount}`;

    // 토스 페이먼츠 결제 시퀀스
    tossLink(totalAmount, orderNumber, realOrderName, successUrl, failUrl);
  }

  function tossLink(totalAmount, orderNumber, orderName, successUrl, failUrl) {
    tossPayments.requestPayment('카드', { // 결제 수단 파라미터
      // 결제 정보 파라미터
      amount: totalAmount,
      orderId: orderNumber,
      orderName: orderName,
      successUrl: successUrl,
      failUrl: failUrl,
    })
    .then(resp => {
      let data = resp.json;
      console.log(data)
    })
    .catch(function (error) {
      // 결제 창 off 등의 예외 사항이 발생했을때 감지할 수 있는 곳
      // TODO 주문의 redis 정보들 삭제 및 쿠폰 상태 rollback

      writeContentToAlert(error.message);
      console.error(error);
    });
  }

  function getAddress() {
    new daum.Postcode({
      oncomplete: function (data) {
        var addr = '';
        var extraAddr = '';

        //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
          addr = data.roadAddress;
        } else { // 사용자가 지번 주소를 선택했을 경우(J)
          addr = data.jibunAddress;
        }

        // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
        if (data.userSelectedType === 'R') {
          if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
            extraAddr += data.bname;
          }
          // 건물명이 있고, 공동주택일 경우 추가한다.
          if (data.buildingName !== '' && data.apartment === 'Y') {
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
          if (extraAddr !== '') {
            extraAddr = ' (' + extraAddr + ')';
          }
          addr += ' ' + extraAddr;
        }

        // 우편번호와 주소 정보를 해당 필드에 넣는다.
        // document.getElementById('orderer-post-address').value = data.zonecode;
        document.getElementById("orderer-road-address").value = addr;

        // 커서를 상세주소 필드로 이동한다.
        document.getElementById("orderer-detail-address").focus();
      }
    }).open();
  }


</script>
<!--주문과의 관계가 확정나면 토스 결제창 띄우기 및 결제 시퀀스를 주문 실패 화면에서도 써서 js화 시킬예정-->
<!--<script th:src="@{/js/payment/toss-payment-event.js}"></script>-->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</body>


<script th:src="@{/js/tabler.min.js}"></script>
<script th:src="@{/js/demo.min.js}"></script>
</html>
