<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>Yes Aladin!</title>
  <!-- CSS files -->
  <link th:href="@{/css/tabler.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-flags.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-payments.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/tabler-vendors.min.css}" rel="stylesheet"/>
  <link th:href="@{/css/demo.min.css}" rel="stylesheet"/>

  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body>

<!-- Tabler Core -->
<script type="text/javascript" th:src="@{/js/tabler.min.js}"></script>
<script type="text/javascript" th:src="@{/js/demo.min.js}"></script>
<script src="https://js.tosspayments.com/v1/payment"></script>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="text/javascript">
  $(document).ready(function () {
    $("input:text[numberOnly]").on("keyup", function () {
      $(this).val($(this).val().replace(/[^0-9]/g, ""));
    });
  });
</script>
<span sec:authorize="isAuthenticated()" th:with="auth=true"></span>
<span sec:authorize="!isAuthenticated()" th:with="auth=false"></span>
<div class="wrapper">
  <!-- TODO 1 : HEADER -->
  <div th:replace="~{common/fragments/header :: fragment-header}"></div>

  <!-- TODO 2 : NAV-BAR -->
  <div th:replace="~{common/fragments/navbar :: fragment-nav-bar}"></div>

  <div class="page-wrapper">
    <form method="post">
      <div class="container-xxl py-4 col-12">
        <!-- 주문서 Header -->
        <div class="row row-cards">
          <div class="col-12">
            <div class="text-center mb-4">
              <h1 class="h-auto">주문서</h1>
            </div>
          </div>
        </div>
        <!-- 주문서 Body -->
        <div class="row row-cards">
          <!-- 주문서 Detail -->
          <div class="col-9">
            <!-- 주문서 Step -->
            <div class="card card-md">
              <div class="card-body p-0">
                <ul class="steps steps-blue steps-counter m-2">
                  <li class="step-item">카트</li>
                  <li class="step-item active">주문</li>
                  <li class="step-item">결제</li>
                  <li class="step-item">완료</li>
                </ul>
              </div>
            </div>
            <!-- 주문서 Main -->
            <div class="card card-md">
              <div class="card-body">
                <!-- 주문인/수령인 정보 입력 -->
                <div class="row">
                  <!-- 주문인 정보 입력 -->
                  <div class="col-6">
                    <h3 class="card-title">주문인 정보 입력</h3>
                    <div class="card card-md">
                      <div class="card-body p-2">
                        <label class="form-label required">주문인 이름</label>
                        <input id="orderer-name" name="ordererName"
                               type="text" class="form-control" placeholder="홍길동"
                               th:readonly="${info.name != null}" th:value="${info.name}"
                               maxlength="20">
                        <label class="form-label required mt-2">전화번호</label>
                        <input class="form-control" id="orderer-phone-number"
                               name="ordererPhoneNumber" type="tel" maxlength="11"
                               placeholder="띄어쓰기 없이 붙여주세요.(ex: 01012341234)"
                               data-mask="000 0000 0000" data-mask-visible="true" autocomplete="off"
                               th:readonly="${info.phoneNumber != null}"
                               th:value="${info.phoneNumber}"
                               pattern="/^01([0|1])\d{4}\d{4}$/"
                               oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                      </div>
                    </div>
                  </div>
                  <!-- 수령인 정보 입력 -->
                  <div class="col-6">
                    <h3 class="card-title">
                      수령인 정보 입력
                      <!-- 주문인과 동일시 시키는 버튼 -->
                      <span class="float-end text-muted">
                        <small>주문인과 동일</small>
                        <input id="receiver-check-box" class="form-check-input" type="checkbox">
                      </span>
                    </h3>
                    <div class="card card-md">
                      <div class="card-body p-2">
                        <label class="form-label required">수령인 이름</label>
                        <input type="text" class="form-control" id="receiver-name"
                               name="recipientName"
                               placeholder="홍길동" maxlength="20">
                        <label class="form-label required mt-2">전화번호</label>
                        <input type="text" class="form-control" id="receiver-phone-number"
                               name="recipientPhoneNumber"
                               maxlength="11" autocomplete="off" placeholder="띄어쓰기 없이 붙여주세요."
                               data-mask="000 0000 0000" data-mask-visible="true"
                               pattern="/^01([0|1])\d{4}\d{4}$/"
                               oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                      </div>
                    </div>
                  </div>
                </div>
                <br/>
                <!-- 배송지 정보 입력 -->
                <h3 class="card-title">배송 정보 입력</h3>
                <div class="card card-md">
                  <div class="card-body">
                    <!-- 배송 정보 Header -->
                    <div class="row mb-2 h-auto">
                      <div class="col-9">
                        <label class="form-label required d-inline">
                          주소
                        </label>
                      </div>
                      <div class="col-3">
                        <a sec:authorize="isAuthenticated()"
                           class="btn btn-outline-primary btn-modal btn-sm w-full"
                           data-bs-toggle="modal" data-bs-target="#modal-report">
                          배송지 선택
                        </a>
                        <a sec:authorize="!isAuthenticated()" type="button"
                           class="btn btn-outline-secondary btn-sm float-end d-inline"
                           onclick="getAddress();">
                          우편번호 찾기
                        </a>
                      </div>
                    </div>
                    <!-- 배송 정보 Body -->
                    <div class="card-body p-0">
                      <input sec:authorize="isAuthenticated()" name="ordererAddressId" type="hidden"
                             th:value="${info.getDefaultAddress() != null ? info.getDefaultAddress().id : ''}">
                      <div class="row w-full ms-0">
                        <div class="col-3 ps-0">
                          <input type="text" class="form-control" id="orderer-post-address"
                                 name="ordererPostAddress" placeholder="우편번호" readonly
                                 th:value="${info.getDefaultAddress() != null ? info.getDefaultAddress().getPostAddress() : ''}">
                        </div>
                        <div class="col-9 ps-0 pe-0">
                          <input type="text" class="form-control" id="orderer-road-address"
                                 name="ordererRoadAddress" placeholder="도로명 주소" readonly
                                 th:value="${info.getDefaultAddress() != null ? info.getDefaultAddress().getRoadAddress() : ''}">
                        </div>
                      </div>
                      <input type="text" class="form-control mt-1" id="orderer-detail-address"
                             name="ordererDetailAddress" placeholder="상세 주소"
                             th:value="${info.getDefaultAddress() != null ? info.getDefaultAddress().getDetailAddress() : ''}">
                    </div>
                    <label class="form-label d-lg-inline float-start mt-2">희망배송날짜</label>
                    <input class="form-control mb-2" id="datepicker"
                           type="date" name="orderExpectedDate"
                           th:min="${#calendars.format( #calendars.createNow(), 'yyyy-MM-dd')}">
                    <span class="form-check-description text-end">미선택시 가장 가까운 날로 배송될 예정입니다.</span>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <h3 class="card-title">주문 상품 정보</h3>
                <div class="card card-md">
                  <div class="table-responsive">
                    <table class="table table-vcenter text-center scrollable scroll-x">
                      <thead>
                      <tr>
                        <th class="w-1"></th>
                        <th>상품번호</th>
                        <th>상품명</th>
                        <th>가격</th>
                        <th>적립예정포인트</th>
                        <th>수량</th>
                        <th>개별쿠폰 적용</th>
                      </tr>
                      </thead>
                      <tbody th:each="product:${info.orderProducts}">
                      <tr>
                        <td th:text="${productStat.index + 1}">
                          <input type="hidden" name="orderProducts"
                                 th:value="${info.orderProducts}">
                        </td>
                        <td th:text="${product.isbn}"></td>
                        <td th:text="${product.title}"></td>
                        <td>
                          <del class="fs-6"
                               th:text="${#numbers.formatInteger(product.actualPrice, 1, 'COMMA')}">
                          </del>
                          <span class="text-danger"
                                th:id="${'order-product-price-' + productStat.index}"
                                th:text="${#numbers.formatInteger(product.getSalePrice(), 1, 'COMMA')}">
                          </span>
                        </td>
                        <td th:text="${product.expectedPoint}"></td>
                        <td th:id="${'order-product-quantity-' + productStat.index}"
                            th:text="${product.quantity}"></td>
                        <td>
                          <!--회원 : 쿠폰 사용 -->
                          <div sec:authorize="isAuthenticated()">
                            <!--TODO 개별 쿠폰 적용하기-->
                            <button sec:authorize="isAuthenticated()" type="button"
                                    class="btn btn-outline-secondary btn-sm float-end">
                              쿠폰 적용
                            </button>
                            <span hidden="hidden">
                              <button type="button" class="btn btn-outline-danger btn-sm float-end">
                                쿠폰 취소
                              </button>
                              <span name="order-product-price">할인된 금액</span>
                            </span>
                          </div>
                          <!--비회원-->
                          <span sec:authorize="!isAuthenticated()">사용불가</span>
                        </td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="float-end"> 결제 예상 금액 : <span id="expected-purchase-amount">0</span>원
                </div>
              </div>
              <div sec:authorize="isAuthenticated()" class="card-body">
                <h3 class="card-title">추가할인</h3>
                <div class="card card-md">
                  <div class="card-body">
                    <div class="form-label">
                      <!--             TODO  전체/카테고리 쿠폰-->
                      전체/카테고리 쿠폰 적용
                      <button type="button" class="btn btn-outline-secondary btn-sm">
                        쿠폰 선택
                      </button>
                      <span class="float-end w-auto">
                        - <input class="form-control form-control-sm w-auto" style="display:inline"
                                 id="coupon-applied-amount" value="0" readonly type="text"> 원
                      </span>
                    </div>
                    <!--TODO 사용한 쿠폰 목록 보여주기-->
                    <div id="used-coupons"></div>
                  </div>
                  <div class="card-body">
                    <div class="form-group mb-3 row">
                      <label class="form-label col-3 col-form-label">포인트 적용</label>
                      <div class="col text-end">
                        - <input class="form-control form-control-sm w-auto"
                                 style="display: inline" name="orderPoint"
                                 id="point-applied-amount" value="0" type="text" numberOnly
                                 oninput="pointOverCheck(this)"
                                 onchange="pointValidCheck(this)"> 원
                      </div>
                      <small class="float-end" style="color: #c13333" id="point-alert"
                             hidden="hidden">
                        값을 입력해주세요.
                      </small>
                      <small style="float:right;" class="form-hint text-end">
                        사용가능한 포인트 :
                        <span id="owned_point" type="text" th:text="${info.point}"></span>
                        원 (1000원 단위로 사용가능)
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 주문서 Summary-->
          <div class="col-3">
            <div class="sticky-top">
              <div class="card card-md">
                <div class="card-body">
                  <h1 class="card-title text-center">
                    영수증
                  </h1>
                  <div class="hr-text">상품 금액</div>
                  <h3 class="card-title">
                    총 상품 금액
                    <span style="float: right">원</span>
                    <input class="d-none" id="total-product-price-hidden"
                           name="productTotalAmount" value="0">
                    <span style="float: right" id="total-product-price">0</span>
                  </h3>
                  <div class="hr-text">결제 금액</div>
                  <div class="row text-end mb-1">
                    <input type="hidden" id="shipping-fee-hidden" name="shippingFee">
                    <small>배달비 : <span id="shipping-fee"></span> 원</small>
                  </div>
                  <div class="row text-end">
                    <small class="float-end d-inline">
                      <label class="form-check form-switch d-inline">
                        <input type="hidden" name="wrappingFee" value="0">
                        <input class="form-check-input m-auto" id="wrapping-check" type="checkbox">
                      </label>
                      포장비 : 3,000원
                    </small>
                  </div>
                  <br/>
                  <h3 class="card-title">
                    총 결제 금액
                    <span style="float: right">원</span>
                    <span style="float: right" id="total-payment-price">0</span>
                  </h3>
                  <div class="mt-2">
                    <button sec:authorize="isAuthenticated()" class="btn btn-primary w-100"
                            type="submit" onclick="form.action='/orders/member'">
                      주문서 작성 완료
                    </button>
                    <button sec:authorize="!isAuthenticated()" class="btn btn-primary w-100"
                            type="submit" onclick="form.action='/orders/non-member'">
                      비회원 주문서 작성 완료
                    </button>
                    <div th:replace="~{common/fragments/alert :: custom-alert}"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- TODO 4 : footer -->
<div th:replace="~{common/fragments/footer :: fragment-footer}"></div>

<!--배송지 Modal-->
<div class="modal modal-blur fade" id="modal-report" tabindex="-1" aria-hidden="true"
     style="display: none;">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- 배송지 Header -->
      <div class="modal-header">
        <h5 class="modal-title">배송지 선택</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <!-- 배송지 Body -->
      <div class="modal-body">
        <small class="form-label">새로운 배송지를 선택하고 싶다면 추가 버튼을 클릭하여 새로운 배송지를 등록한 후 사용해주시길 바랍니다.</small>
        <div class="form-selectgroup-boxes row mb-3">
          <div class="col-lg-6" th:each="address:${addresses}">
            <label class="form-selectgroup-item">
              <input type="radio" name="report-type" value="1" class="form-selectgroup-input">
              <span class="form-selectgroup-label d-flex align-items-center p-3">
                <span class="me-3">
                  <span class="form-selectgroup-check"></span>
                </span>
                <span class="form-selectgroup-label-content">
                  <span class="form-selectgroup-title strong mb-1"
                        th:text="${address.address}"></span>
                </span>
              </span>
            </label>
            <a class="btn btn-outline-danger" onclick="">
              삭제
            </a>
          </div>
        </div>
      </div>
      <!-- 배송지 Footer -->
      <div class="modal-footer">
        <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">
          등록
        </a>
        <a href="#" class="btn btn-primary ms-auto" data-bs-dismiss="modal">
          선택
        </a>
      </div>
    </div>
  </div>
</div>

<div class="d-none" id="shop-server-url"
     th:data-url="${@environment.getProperty('yesaladin.gateway.shop')}"></div>
<div class="d-none" id="front-server-url"
     th:data-url="${@environment.getProperty('yesaladin.front.url')}"></div>
</body>

<!--주문 금액 변경 시 반영하는 함수-->
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", () => {
    setExpectedTotalPrice();
  });

  function setExpectedTotalPrice() {
    var size = [[${info.orderProducts.size}]];
    var expectedPurchaseAmount = document.getElementById("expected-purchase-amount");

    var priceList = [];
    var quantityList = [];

    var sum = 0;
    for (let i = 0; i < size; i++) {
      priceList[i] = document.getElementById("order-product-price-" + i);
      quantityList[i] = document.getElementById("order-product-quantity-" + i);

      var quantity = parseInt(quantityList[i].innerText.replace(/\D/g, ''));
      var price = parseInt(priceList[i].innerText.replace(/\D/g, ''));

      sum += price * quantity;
    }
    expectedPurchaseAmount.innerText = sum.toLocaleString();

    setProductTotalPrice();
  }

  function setProductTotalPrice() {
    var totalProductPrice = document.getElementById("total-product-price");
    var totalProductPriceHidden = document.getElementById("total-product-price-hidden");

    var expectedPurchaseAmount = document.getElementById("expected-purchase-amount");
    var couponAppliedAmount = document.getElementById("coupon-applied-amount");
    var pointAppliedAmount = document.getElementById("point-applied-amount");

    var auth = [[${auth}]]
    var totalPrice = parseInt(expectedPurchaseAmount.innerText.replace(/\D/g, ''));

    if (auth) {
      totalPrice -= (parseInt(couponAppliedAmount.value) + parseInt(pointAppliedAmount.value));
    }
    totalProductPrice.innerText = totalPrice.toLocaleString();
    totalProductPriceHidden.value = totalPrice;

    setPaymentTotalPrice();
  }

  function setPaymentTotalPrice() {
    const totalPaymentPrice = document.getElementById("total-payment-price");

    const totalProductPrice = parseInt(
        document.getElementById("total-product-price").innerText.replace(/\D/g, ''));

    const shippingFeeHidden = document.getElementById("shipping-fee-hidden");
    const shippingFee = document.getElementById("shipping-fee");
    const wrappingFee = document.getElementById("wrapping-fee");

    var totalPrice = 0;

    if (totalProductPrice >= 30000) {
      shippingFeeHidden.value = 0;
      shippingFee.innerText = "0";
    } else {
      shippingFeeHidden.value = 3000;
      shippingFee.innerText = (3000).toLocaleString();
      totalPrice += 3000;
    }
    totalPrice += Number(wrappingFee.value) + totalProductPrice;

    totalPaymentPrice.innerText = totalPrice.toLocaleString();
  }
</script>

<!--버튼 이벤트 관련 함수-->
<script th:inline="javascript">
  const wrappingFee = document.getElementById("wrapping-fee");

  // "주문인과 동일" 버튼 이벤트
  document.getElementById("receiver-check-box").addEventListener('change', (event) => {
    const orderer = document.getElementById("orderer-name");
    const ordererPhoneNumber = document.getElementById("orderer-phone-number");

    const receiver = document.getElementById("receiver-name");
    const receiverPhoneNumber = document.getElementById("receiver-phone-number");

    if (event.currentTarget.checked) {
      if (orderer.value === "" || ordererPhoneNumber.value === "") {
        alert("주문인의 정보를 먼저 입력해주시길 바랍니다.")
        event.currentTarget.checked = false;
        return;
      }
      receiver.value = orderer.value;
      receiverPhoneNumber.value = ordererPhoneNumber.value;

      receiver.disabled = true;
      receiverPhoneNumber.disabled = true;
    } else {
      receiver.disabled = false;
      receiverPhoneNumber.disabled = false;
    }
  })
  // "포장" 버튼 이벤트
  document.getElementById("wrapping-check").addEventListener('change', function () {
    if (this.checked) {
      this.text = wrappingFee.value = 3000;
    } else {
      this.text = wrappingFee.value = 0;
    }
    setPaymentTotalPrice();
  });
</script>

<!-- 검사 -->
<script th:inline="javascript">
  function pointOverCheck(e) {
    const alert = document.getElementById("point-alert");
    const expectedPrice = parseInt(document.getElementById("expected-purchase-amount").innerText);
    const userPoint = [[${point}]];

    var curPoint = parseInt(e.value);

    alert.hidden = true;
    if (e.value === "") {
      alert.hidden = false;
    }
    if (curPoint > userPoint) {
      curPoint = userPoint;
    }
    if (curPoint > expectedPrice) {
      curPoint = expectedPrice;
    }
    e.value = curPoint;
  }

  function pointValidCheck(e) {
    var amount = e.value;
    if (e.value === "" || e.value < 0) {
      amount = 0;
      document.getElementById("point-alert").hidden = true;
    } else if (e.value % 1000 > 0) {
      amount = parseInt(e.value / 1000) * 1000;
    }
    e.value = amount;
    setProductTotalPrice();
  }
</script>

<!-- 주문 -->
<script th:inline="javascript">
  const ordererName = document.getElementById("orderer-name");
  const ordererPhoneNumber = document.getElementById("orderer-phone-number");
  const recipientName = document.getElementById("recipient-name");
  const recipientPhoneNumber = document.getElementById("recipient-phone-number");
  const ordererPostAddress = document.getElementById("orderer-post-address");
  const ordererRoadAddress = document.getElementById("orderer-road-address");
  const ordererDetailAddress = document.getElementById("orderer-detail-address");

  const address = [ordererPostAddress.value, ordererRoadAddress.value, ordererDetailAddress.value];

  function orderCheck(e) {
    //1.입력값유효성검사
    if (ordererName.value.toString() == ""
        || ordererPhoneNumber.value.toString() == ""
        || recipientName.value.toString() == ""
        || recipientPhoneNumber.value.toString() == ""
        || ordererPostAddress.value.toString() == ""
        || ordererRoadAddress.value.toString() == ""
        || ordererDetailAddress.value.toString() == ""
    ) {
      alert("빈칸을 전부 채워주세요.");
      return;
    }
    if (address.join('/').length > 255) {
      alert("주소가 너무 깁니다.");
      return;
    }

    // 2. 쿠폰 검증(회원)
    // 3. 주문
  }
</script>
</html>
